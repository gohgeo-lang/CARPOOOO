<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CARPOOOO - 차량 등록</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="style.css" rel="stylesheet" />

    <style>
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #29335a;
        /* 브랜드 파란색 */
        color: white;
      }
    </style>
  </head>

  <body>
    <div class="header px-3 py-2">
      <!-- 뒤로가기 버튼 -->
      <button class="btn btn-link text-white me-2 p-0" onclick="goBackOrHome()">
        <i class="bi bi-chevron-left fs-4"></i>
      </button>
      <!-- 제목 -->
      <h4 class="mb-0">차량등록</h4>
    </div>

    <div class="container mt-4" style="max-width: 500px">
      <div class="card p-4">
        <form id="carForm">
          <div class="mb-3">
            <label class="form-label">차량 번호</label>
            <input type="text" class="form-control" id="carNumber" required />
          </div>
          <div class="mb-3">
            <label class="form-label">제조사</label>
            <select class="form-select" id="carCompany" required>
              <option value="">제조사 선택</option>
              <option value="현대">현대</option>
              <option value="기아">기아</option>
              <option value="BMW">BMW</option>
              <option value="BENZ">BENZ</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">모델</label>
            <input type="text" class="form-control" id="carModel" required />
          </div>
          <div class="mb-3">
            <label class="form-label">차량 크기</label>
            <select class="form-select" id="carSize" required>
              <option value="">크기 선택</option>
              <option value="경형">경형</option>
              <option value="준중형">준중형</option>
              <option value="준대형">준대형</option>
              <option value="대형">대형</option>
              <option value="SUV">SUV</option>
              <option value="RV">RV</option>
            </select>
          </div>
          <button type="submit" class="btn btn-primary w-100">
            차량 등록하기
          </button>
        </form>
      </div>
    </div>
    <script>
      // 쿼리 파라미터 읽기
      function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
      }
      const from = getQueryParam("from"); // booking 또는 profile
      console.log(
        "쿼리 파라미터 from =",
        from,
        "전체 URL =",
        window.location.href
      );

      const currentUser = JSON.parse(localStorage.getItem("currentUser"));
      if (!currentUser) {
        alert("로그인 후 이용 가능합니다.");
        window.location.href = "login.html";
      }

      // 차량 등록 폼
      document
        .getElementById("carForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const carNumber = document.getElementById("carNumber").value.trim();
          const carCompany = document.getElementById("carCompany").value;
          const carModel = document.getElementById("carModel").value.trim();
          const carSize = document.getElementById("carSize").value;

          if (!carNumber || !carCompany || !carModel || !carSize) {
            alert("모든 항목을 입력해주세요.");
            return;
          }

          if (!currentUser.cars) currentUser.cars = [];
          currentUser.cars.push({ carNumber, carCompany, carModel, carSize });

          // users 배열 갱신
          let users = JSON.parse(localStorage.getItem("users")) || [];
          users = users.map((u) =>
            u.phone === currentUser.phone ? currentUser : u
          );
          localStorage.setItem("users", JSON.stringify(users));
          localStorage.setItem("currentUser", JSON.stringify(currentUser));

          alert("차량이 등록되었습니다!");
          goBackOrHome(); // 저장 후 이동
        });

      function goBackOrHome() {
        const from = getQueryParam("from"); // 다시 읽기 안전
        console.log("goBackOrHome called, from =", from);

        if (from && from.toLowerCase() === "booking") {
          window.location.href = "booking.html?step=3";
        } else if (from && from.toLowerCase() === "profile") {
          window.location.href = "car-profile.html";
        } else {
          window.location.href = "index.html";
        }
      }
    </script>
  </body>
</html>
