<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CARPOOOO - ì´ìš©ë‚´ì—­</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="style.css" rel="stylesheet" />

    <style>
      body.usage {
        padding-top: 60px;
      }

      /* í—¤ë”: mypage ìŠ¤íƒ€ì¼ ì°¸ê³  */
      .header {
        background: #fff;
        border-bottom: 1px solid #eee;
        display: flex;
        align-items: center;
        gap: 8px;
        height: 60px;
        padding: 0 15px;
      }

      .header h4 {
        font-size: 20px;
        color: #000;
        margin: 0;
      }

      /* íƒ­ ë©”ë‰´ */
      .nav-tabs {
        border-bottom: 1px solid #eee;
      }

      .nav-tabs .nav-link {
        border: none;
        font-weight: 500;
        color: #666;
      }

      .nav-tabs .nav-link.active {
        color: #1e90ff;
        font-weight: bold;
        border-bottom: 2px solid #1e90ff;
        background: none;
      }

      /* ì˜ˆì•½ ì¹´ë“œ */
      .booking-card {
        background: #fff;
        border: 1px solid #eee;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      }

      .booking-card h6 {
        font-weight: bold;
      }

      .booking-info {
        font-size: 0.9rem;
        color: #555;
        margin: 2px 0;
      }

      /* ìƒíƒœ ë°°ì§€ */
      .badge-status {
        padding: 4px 10px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: bold;
      }

      .badge-pending {
        background: #ffc107;
        color: #fff;
      }

      .badge-done {
        background: #28a745;
        color: #fff;
      }

      .badge-cancel {
        background: #dc3545;
        color: #fff;
      }

      .badge-confirmed {
        background: #007bff;
        color: #fff;
      }
    </style>
  </head>

  <body class="usage">
    <!-- í—¤ë” -->
    <div class="header">
      <button class="btn btn-link text-dark me-1" onclick="goBackOrHome()">
        <i class="bi bi-chevron-left fs-4"></i>
      </button>
      <h4>ì´ìš©ë‚´ì—­</h4>
    </div>

    <!-- íƒ­ ë©”ë‰´ -->
    <ul class="nav nav-tabs px-3 mt-2" id="usageTabs">
      <li class="nav-item">
        <button
          class="nav-link"
          id="sub-tab"
          data-bs-toggle="tab"
          data-bs-target="#subscription"
        >
          êµ¬ë… ë‚´ì—­
        </button>
      </li>
      <li class="nav-item">
        <button
          class="nav-link active"
          id="res-tab"
          data-bs-toggle="tab"
          data-bs-target="#reservations"
        >
          ì˜ˆì•½ ë‚´ì—­
        </button>
      </li>
      <li class="nav-item">
        <button
          class="nav-link"
          id="done-tab"
          data-bs-toggle="tab"
          data-bs-target="#completed"
        >
          ìµœê·¼ ì´ìš© ê¸°ë¡
        </button>
      </li>
    </ul>

    <!-- ë°°ì§€ì„¤ëª… -->
    <div class="container mt-2">
      <div class="alert alert-light border small text-muted" role="alert">
        <ul class="mb-0 ps-3">
          <li><b>ì˜ˆì•½ëŒ€ê¸°</b>: ì˜ˆì•½ ìˆ˜ì • ë° ì·¨ì†Œ ê°€ëŠ¥ (ìœ„ì•½ê¸ˆ ì—†ìŒ)</li>
          <li>
            <b>ì˜ˆì•½í™•ì •</b>: ì˜ˆì•½ ìˆ˜ì • ë¶ˆê°€, ì·¨ì†ŒëŠ” ê°€ëŠ¥ (ì‹œì ì— ë”°ë¼ ìœ„ì•½ê¸ˆ
            ë°œìƒ)
          </li>
          <li><b>ì™„ë£Œ</b>: ì¬ì˜ˆì•½ë§Œ ê°€ëŠ¥</li>
          <li><b>ì·¨ì†Œë¨</b>: ê¸°ë¡ í™•ì¸ë§Œ ê°€ëŠ¥</li>
        </ul>
      </div>
    </div>

    <!-- íƒ­ ì½˜í…ì¸  -->
    <div class="tab-content container mt-3">
      <!-- êµ¬ë… ë‚´ì—­ -->
      <div class="tab-pane fade" id="subscription">
        <div id="subContainer">
          <!-- JSì—ì„œ êµ¬ë… ì—†ìœ¼ë©´ display:none ì²˜ë¦¬ -->
          <div class="booking-card">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">ì •ê¸° ì„¸ì°¨ êµ¬ë… (ì›” 4íšŒ)</h6>
              <span class="badge-status badge-pending">êµ¬ë… ì¤‘</span>
            </div>
            <p class="booking-info">
              <i class="bi bi-calendar-event"></i> ë‹¤ìŒ ê²°ì œì¼: 2025.09.01
            </p>
            <div class="mt-2">
              <button class="btn btn-sm btn-outline-danger">êµ¬ë… í•´ì§€</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ì˜ˆì•½ ë‚´ì—­ -->
      <div class="tab-pane fade show active" id="reservations">
        <div class="booking-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">í”„ë¦¬ë¯¸ì—„ ì„¸ì°¨ ì½”ìŠ¤</h6>
            <span class="badge-status badge-pending">ì˜ˆì•½ ì˜ˆì •</span>
          </div>
          <p class="booking-info">
            <i class="bi bi-calendar-event"></i> 2025.09.05 (ê¸ˆ) ì˜¤í›„ 2ì‹œ
          </p>
          <p class="booking-info">
            <i class="bi bi-geo-alt"></i> ì„œìš¸ ê°•ë‚¨êµ¬ â—‹â—‹ë™ â—‹â—‹ì•„íŒŒíŠ¸
          </p>
          <div class="mt-2">
            <button class="btn btn-sm btn-outline-primary">ìƒì„¸ë³´ê¸°</button>
            <button class="btn btn-sm btn-outline-danger">ì˜ˆì•½ì·¨ì†Œ</button>
          </div>
        </div>
      </div>

      <!-- ìµœê·¼ ì´ìš© ê¸°ë¡ -->
      <div class="tab-pane fade" id="completed">
        <div class="booking-card">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">ì¼ë°˜ ì„¸ì°¨ ì½”ìŠ¤</h6>
            <span class="badge-status badge-done">ì™„ë£Œ</span>
          </div>
          <p class="booking-info">
            <i class="bi bi-calendar-event"></i> 2025.08.20 (ìˆ˜) ì˜¤í›„ 1ì‹œ
          </p>
          <p class="booking-info">
            <i class="bi bi-geo-alt"></i> ì„œìš¸ ì†¡íŒŒêµ¬ â—‹â—‹ì£¼íƒ
          </p>
          <div class="mt-2">
            <button class="btn btn-sm btn-outline-secondary">ì¬ì˜ˆì•½í•˜ê¸°</button>
          </div>
        </div>
      </div>
    </div>
    <!-- ì˜ˆì•½ ì¹´ë“œ ìƒì„± JS -->
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (
          !currentUser ||
          !currentUser.history ||
          currentUser.history.length === 0
        ) {
          document.querySelector(".tab-content").innerHTML =
            "<p class='text-center text-muted mt-5'>ì˜ˆì•½ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
          return;
        }

        const history = currentUser.history;
        const resContainer = document.getElementById("reservations");
        const doneContainer = document.getElementById("completed");
        const subContainer = document.getElementById("subContainer");

        resContainer.innerHTML = "";
        doneContainer.innerHTML = "";
        subContainer.innerHTML = "";

        history.forEach((h, idx) => {
          const card = document.createElement("div");
          card.className = "booking-card";

          // ìƒíƒœë³„ ë±ƒì§€
          let badgeClass = "badge-pending";
          let badgeText = "ì˜ˆì•½ëŒ€ê¸°";
          if (h.status === "ì˜ˆì•½í™•ì •") {
            badgeClass = "badge-confirmed";
            badgeText = "ì˜ˆì•½í™•ì •";
          } else if (h.status === "ì™„ë£Œ") {
            badgeClass = "badge-done";
            badgeText = "ì™„ë£Œ";
          } else if (h.status === "ì·¨ì†Œ") {
            badgeClass = "badge-cancel";
            badgeText = "ì·¨ì†Œë¨";
          }

          // ìƒíƒœë³„ ë²„íŠ¼
          let actionButtons = "";
          if (h.status === "ì˜ˆì•½ëŒ€ê¸°") {
            actionButtons = `
            `;
          } else if (h.status === "ì˜ˆì•½í™•ì •") {
            const now = new Date();
            const bookingDate = new Date(`${h.dateStr} ${h.time}`);
            const diffDays = (bookingDate - now) / (1000 * 60 * 60 * 24);

            if (diffDays <= 0) {
              actionButtons = `<button class="btn btn-sm btn-outline-danger" onclick="cancelBooking(${idx}, true)">ì·¨ì†Œí•˜ê¸°(ìˆ˜ìˆ˜ë£Œ)</button>`;
            } else {
              actionButtons = `<button class="btn btn-sm btn-outline-danger" onclick="cancelBooking(${idx})">ì·¨ì†Œí•˜ê¸°</button>`;
            }
          } else if (h.status === "ì™„ë£Œ") {
            actionButtons = `<button class="btn btn-sm btn-outline-secondary" onclick="rebook(${idx})">ì¬ì˜ˆì•½í•˜ê¸°</button>`;
          }

          // ì¹´ë“œ ë³¸ë¬¸
          card.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">${h.course || "ì„¸ì°¨ ì½”ìŠ¤"}</h6>
              <span class="badge-status ${badgeClass}">${badgeText}</span>
            </div>
            <p class="booking-info"><i class="bi bi-calendar-event"></i> ${
              h.dateStr
            } ${h.time}</p>
            <p class="booking-info"><i class="bi bi-geo-alt"></i> ${
              h.carNumber
            } Â· ${h.carCompany} ${h.carModel}</p>
            <p class="booking-info"><i class="bi bi-geo-alt"></i> ${
              h.address || ""
            } ${h.addressDetail || ""}</p>
          <p class="booking-info"><i class="bi bi-cash"></i> ${
            h.finalPrice?.toLocaleString() || 0
          }ì›</p>
          <div class="mt-2">${actionButtons}</div>
        `;

          // êµ¬ë… ì¹´ë“œ ë³„ë„ í‘œì‹œ
          if (h.washType === "ì •ê¸°ì„¸ì°¨" && h.months && h.months > 0) {
            const subCard = document.createElement("div");
            subCard.className = "booking-card";
            subCard.innerHTML = `
      <div class="d-flex justify-content-between align-items-center mb-2">
          <h6 class="mb-0">ì •ê¸° ì„¸ì°¨ êµ¬ë… (${h.months}ê°œì›”)</h6>
          <span class="badge-status badge-pending">êµ¬ë… ì¤‘</span>
      </div>
      <p class="booking-info"><i class="bi bi-calendar-event"></i> ì‹œì‘ì¼: ${h.dateStr}</p>
      <p class="booking-info"><i class="bi bi-geo-alt"></i> ${h.carNumber} Â· ${h.carCompany} ${h.carModel}</p>
      <div class="mt-2">
          <button class="btn btn-sm btn-outline-danger">êµ¬ë… í•´ì§€</button>
      </div>
    `;
            subContainer.appendChild(subCard);
          }

          card.addEventListener("click", (e) => {
            if (e.target.tagName === "BUTTON") return; // ë²„íŠ¼ í´ë¦­ì€ ê·¸ëŒ€ë¡œ ë™ì‘
            viewBooking(idx); // ì¹´ë“œ í´ë¦­ì€ í•­ìƒ ìƒì„¸í˜ì´ì§€ ì´ë™
          });

          function viewBooking(idx) {
            localStorage.setItem("viewBookingIndex", idx);
            sessionStorage.setItem("fromDetail", "true"); // ğŸ‘‰ í”Œë˜ê·¸ ì €ì¥
            window.location.href = "usage.html";
          }

          // ìƒíƒœë³„ ì»¨í…Œì´ë„ˆ ë°°ì¹˜
          if (h.status === "ì™„ë£Œ") {
            doneContainer.appendChild(card);
          } else {
            resContainer.appendChild(card);
          }
        });

        // êµ¬ë… ë‚´ì—­ ì—†ìœ¼ë©´ íƒ­ ìˆ¨ê¹€
        if (subContainer.innerHTML.trim() === "") {
          document.getElementById("sub-tab").style.display = "none";
          document.getElementById("subscription").style.display = "none";
        }
      });

      function goBackOrHome() {
        // íˆìŠ¤í† ë¦¬ì— ì´ì „ í˜ì´ì§€ê°€ ìˆëŠ” ê²½ìš°
        if (document.referrer && document.referrer !== window.location.href) {
          history.back();
        } else {
          // ì´ì „ í˜ì´ì§€ê°€ ì—†ìœ¼ë©´ í™ˆìœ¼ë¡œ
          window.location.href = "index.html"; // í™ˆ ì£¼ì†Œì— ë§ê²Œ ìˆ˜ì •
        }
      }

      // ë²„íŠ¼ í•¨ìˆ˜
      function cancelBooking(idx, isSameDay = false) {
        const currentUser = JSON.parse(localStorage.getItem("currentUser"));
        if (!currentUser || !currentUser.history) return;

        if (isSameDay) {
          if (
            !confirm(
              "ë‹¹ì¼ ì·¨ì†ŒëŠ” ìˆ˜ìˆ˜ë£Œê°€ ë¶€ê³¼ë©ë‹ˆë‹¤. ê·¸ë˜ë„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?"
            )
          )
            return;
        } else {
          if (!confirm("ì •ë§ ì˜ˆì•½ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        }

        currentUser.history[idx].status = "ì·¨ì†Œ";
        currentUser.history[idx].cancelDate = new Date().toLocaleString();
        currentUser.history[idx].cancelFee = isSameDay ? "ìˆ˜ìˆ˜ë£Œ ë°œìƒ" : "ì—†ìŒ";

        localStorage.setItem("currentUser", JSON.stringify(currentUser));
        alert("ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        location.reload();
      }

      function editBooking(idx) {
        localStorage.setItem("editBookingIndex", idx);
        window.location.href = "booking.html";
      }

      function rebook(idx) {
        localStorage.setItem("rebookIndex", idx);
        window.location.href = "booking.html";
      }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
