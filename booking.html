<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARPOOOO - 세차 예약하기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link href="booking.css" rel="stylesheet">
    <style>
        .step {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        .step.active {
            display: block;
            opacity: 1;
        }

        #calendar {
            min-height: 500px;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <!-- 상단 헤더 -->
    <div class="header">
        <div>
            <h4 class="fw-bold mb-0">세차 예약하기</h4>
        </div>
    </div>

    <div class="container mt-4">
        <!-- 진행바 -->
        <div class="progress mb-4">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 20%;">Step 1 / 5</div>
        </div>

        <!-- 예약 히스토리 모달 -->
        <div class="modal fade" id="historyModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">최근기록</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="historyList"></div>
                </div>
            </div>
        </div>

        <!-- Step 1: 예약자 정보 -->
        <div class="step active" id="step1">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">예약자 정보</h5>
                <button type="button" class="btn btn-link btn-sm text-muted text-decoration-none" data-bs-toggle="modal"
                    data-bs-target="#historyModal">
                    이전기록에서 입력하기
                </button>
            </div>
            <input type="text" class="form-control mb-2" id="name" placeholder="예약자 성함">
            <input type="tel" class="form-control mb-2" id="phone" placeholder="연락처">
            <input type="text" class="form-control mb-2" id="address" placeholder="주소 검색" readonly
                onclick="execDaumPostcode()">
            <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
            <script>
                function execDaumPostcode() {
                    new daum.Postcode({
                        oncomplete: function (data) {
                            document.getElementById("address").value = data.address;
                        }
                    }).open();
                }
            </script>
            <input type="text" class="form-control mb-2" id="addressDetail" placeholder="상세 위치 (예: 아파트 동/호)">
            <button class="btn btn-primary w-100 mt-3" onclick="nextStep(2)">다음</button>
        </div>

        <!-- Step 2: 차량 정보 -->
        <div class="step" id="step2">
            <h5>차량 정보</h5>
            <ul class="nav nav-tabs" id="carTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#mycar"
                        type="button">내 차량에서 선택</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#newcar"
                        type="button">새로운 차량 등록</button></li>
            </ul>
            <div class="tab-content mt-3">
                <div class="tab-pane fade show active" id="mycar">
                    <div id="myCarList" class="list-group"></div>
                </div>
                <div class="tab-pane fade" id="newcar">
                    <input type="text" class="form-control mb-2" id="carNumber" placeholder="차량 번호판">
                    <select class="form-select mb-2" id="carCompany">
                        <option value="">브랜드 선택</option>
                    </select>
                    <select class="form-select mb-2" id="carModel">
                        <option value="">모델 선택</option>
                    </select>
                    <div class="alert alert-info" id="carSizeBox" style="display:none;"></div>
                </div>
            </div>
            <button class="btn btn-secondary mt-3" onclick="prevStep(1)">이전</button>
            <button class="btn btn-primary mt-3 float-end" onclick="nextStep(3)">다음</button>
        </div>
        <!-- Step3 -->
        <div class="step" id="step3">
            <h5>세차 코스 선택</h5>

            <!-- 1) 세차 종류 -->
            <div class="mb-3">
                <label class="fw-bold">세차 종류</label><br>
                <input type="radio" name="washType" value="일반세차" onchange="selectWashType('일반세차')"> 일반세차
                <input type="radio" name="washType" value="정기세차" onchange="selectWashType('정기세차')"> 정기세차
            </div>

            <!-- 2) 구독개월수 -->
            <div id="subscriptionBox" style="display:none;" class="mb-3">
                <label class="fw-bold">구독 개월 수</label>
                <select id="subscriptionSelect" class="form-select" onchange="updateSubscription(this.value)">
                    <option value="1">1개월 (기본가)</option>
                    <option value="3">3개월 (5% 할인)</option>
                    <option value="6">6개월 (10% 할인)</option>
                    <option value="12">12개월 (20% 할인)</option>
                </select>
            </div>

            <!-- 3) 코스 선택 -->
            <div class="mb-3">
                <label class="fw-bold">코스 선택</label>
                <select id="courseSelect" class="form-select" onchange="selectCourse(this.value)">
                    <option value="">코스를 선택하세요</option>
                    <option value="basic">베이직코스</option>
                    <option value="premium">프리미엄코스</option>
                </select>
            </div>

            <!-- 4) 옵션 -->
            <div class="mb-3">
                <label><input type="checkbox" id="interiorOption" onchange="toggleInterior()"> 실내세차 추가</label>
            </div>

            <!-- 5) 쿠폰 -->
            <button class="btn btn-outline-primary w-100" onclick="openCouponBox()">🎟 쿠폰/상품권 보관함</button>

            <!-- 코스 설명 -->
            <div id="courseDescription" class="mt-3 text-muted small"></div>

            <!-- 버튼 추가 -->
            <button class="btn btn-secondary mt-3" onclick="prevStep(2)">이전</button>
            <button class="btn btn-primary mt-3 float-end" onclick="nextStep(4)">다음</button>

        </div>



        <!-- Step 4: 날짜 & 시간 -->
        <div class="step" id="step4">
            <h5>📅 예약 날짜 & 시간</h5>
            <div id="calendar"></div>
            <div id="timeSlots" class="mt-3"></div>
            <button class="btn btn-secondary mt-3" onclick="prevStep(3)">이전</button>
            <button class="btn btn-primary mt-3 float-end" onclick="nextStep(5)">다음</button>
        </div>

        <!-- Step 5: 확인 -->
        <div class="step" id="step5">
            <h5>✅ 예약 확인</h5>
            <div id="summary" class="border p-3 mb-3 bg-light"></div>
            <button class="btn btn-secondary" onclick="prevStep(4)">이전</button>
            <button class="btn btn-success float-end" onclick="confirmBooking()">결제하기</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="carData.js"></script>
    <script src="courseInfo.js"></script>



    <script>
        let bookingData = {};
        let currentStep = 1;
        let calendar;
        let appliedDiscount = 0;

        // Step 진행바
        function updateProgress(step) {
            currentStep = step;
            const percent = (step / 5) * 100;
            document.getElementById("progressBar").style.width = percent + "%";
            document.getElementById("progressBar").innerText = `Step ${step} / 5`;
        }

        // Step 이동
        function nextStep(step) {
            // Step2로 이동: 예약자 정보 필수
            if (step === 2) {
                const name = document.getElementById("name").value.trim();
                const phone = document.getElementById("phone").value.trim();
                const address = document.getElementById("address").value.trim();
                if (!name) return alert("예약자 성함을 입력해주세요.");
                if (!phone) return alert("연락처를 입력해주세요.");
                if (!address) return alert("주소를 검색해주세요.");
                // 통과 시 bookingData에 반영
                bookingData.name = name;
                bookingData.phone = phone;
                bookingData.address = address + " " + (document.getElementById("addressDetail").value || "");
            }

            // Step3로 이동: 차량 선택 필수
            if (step === 3) {
                if (!bookingData.carCompany || !bookingData.carModel || !bookingData.carSize) {
                    return alert("차량 정보를 선택해주세요.");
                }
            }

            // Step4로 이동: 세차 코스 선택 필수(여기가 빠져 있었음!)
            if (step === 4) {
                if (!bookingData.washType) return alert("세차 종류를 선택해주세요.");
                if (!bookingData.course || !bookingData.courseKey) return alert("코스를 선택해주세요.");
                if (bookingData.washType === "정기세차" && !bookingData.months) {
                    return alert("구독 개월을 선택해주세요.");
                }
            }

            // Step5로 이동: 날짜/시간 필수
            if (step === 5) {
                if (!bookingData.date) return alert("예약 날짜를 선택해주세요.");
                if (!bookingData.time) return alert("예약 시간을 선택해주세요.");
            }

            // --- 실제 화면 전환 ---
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            updateProgress(step);

            // 부가 처리
            if (step === 3) {
                // 가격/카드 갱신 (필요 시)
                if (typeof updateSummaryBar === "function") updateSummaryBar();
            }
            if (step === 4) {
                if (!calendar) initCalendar();
                // 렌더 타이밍 유예
                setTimeout(() => calendar && calendar.render(), 200);
            }
            if (step === 5) {
                if (typeof showSummary === "function") showSummary();
            }
        }

        function prevStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            updateProgress(step);
        }

        // 사용자 기본정보 자동 입력
        document.addEventListener("DOMContentLoaded", () => {
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (currentUser) {
                document.getElementById("name").value = currentUser.name || "";
                document.getElementById("phone").value = currentUser.phone || "";
                document.getElementById("address").value = currentUser.address || "";
                document.getElementById("addressDetail").value = currentUser.addressDetail || "";
                bookingData.name = currentUser.name || "";
                bookingData.phone = currentUser.phone || "";
                bookingData.address = (currentUser.address || "") + " " + (currentUser.addressDetail || "");
            }
            loadMyCars();
            initCarDropdown();
        });

        // 차량 리스트
        function loadMyCars() {
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            const myCarList = document.getElementById("myCarList");
            myCarList.innerHTML = "";
            if (currentUser && currentUser.cars?.length > 0) {
                currentUser.cars.forEach((car, idx) => {
                    const btn = document.createElement("button");
                    btn.className = "list-group-item list-group-item-action";
                    btn.innerText = `${car.carNumber} - ${car.carCompany} ${car.carModel} (${car.carSize})`;
                    btn.onclick = () => {
                        bookingData.carNumber = car.carNumber;
                        bookingData.carCompany = car.carCompany;
                        bookingData.carModel = car.carModel;
                        bookingData.carSize = car.carSize;
                        document.querySelectorAll("#myCarList button").forEach(b => b.classList.remove("active"));
                        btn.classList.add("active");
                    };
                    myCarList.appendChild(btn);
                    if (idx === 0) btn.click();
                });
            } else {
                myCarList.innerHTML = `<p class="text-muted">등록된 차량이 없습니다.</p>`;
            }
        }

        // 브랜드/모델 드롭다운
        function initCarDropdown() {
            const brandSelect = document.getElementById("carCompany");
            const modelSelect = document.getElementById("carModel");
            for (let brand in carData) {
                let opt = document.createElement("option");
                opt.value = brand; opt.textContent = brand;
                brandSelect.appendChild(opt);
            }
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (currentUser && currentUser.cars?.length > 0) {
                const car = currentUser.cars[0];
                brandSelect.value = car.carCompany;
                Object.keys(carData[car.carCompany]).forEach(size => {
                    carData[car.carCompany][size].forEach(model => {
                        let opt = document.createElement("option");
                        opt.value = model; opt.textContent = model;
                        modelSelect.appendChild(opt);
                    });
                });
                modelSelect.value = car.carModel;
                bookingData.carNumber = car.carNumber;
                bookingData.carCompany = car.carCompany;
                bookingData.carModel = car.carModel;
                bookingData.carSize = car.carSize;
            }
            brandSelect.addEventListener("change", () => {
                modelSelect.innerHTML = "<option value=''>모델 선택</option>";
                if (brandSelect.value) {
                    Object.keys(carData[brandSelect.value]).forEach(size => {
                        carData[brandSelect.value][size].forEach(model => {
                            let opt = document.createElement("option");
                            opt.value = model; opt.textContent = model;
                            modelSelect.appendChild(opt);
                        });
                    });
                }
            });
            modelSelect.addEventListener("change", () => {
                const brand = brandSelect.value;
                const model = modelSelect.value;
                let detectedSize = "";
                Object.keys(carData[brand]).forEach(size => {
                    if (carData[brand][size].includes(model)) detectedSize = size;
                });
                bookingData.carCompany = brand;
                bookingData.carModel = model;
                bookingData.carSize = detectedSize;
                bookingData.carNumber = document.getElementById("carNumber").value;
                const box = document.getElementById("carSizeBox");
                box.style.display = "block";
                box.innerText = `자동 분류된 차량 크기: ${bookingData.carSize}`;
            });
        }

        // 가격표 + 선택 복원
        const priceTable = {
            "경형": { one: 25000, month4: 35000, month8: 55000, interior: 10000 },
            "준중형": { one: 30000, month4: 40000, month8: 65000, interior: 10000 },
            "준대형": { one: 35000, month4: 45000, month8: 75000, interior: 10000 },
            "대형": { one: 40000, month4: 50000, month8: 80000, interior: 10000 },
            "SUV": { one: 40000, month4: 50000, month8: 85000, interior: 10000 },
            "RV": { one: 45000, month4: 55000, month8: 90000, interior: 10000 }
        };


        function selectWashType(type) {
            bookingData.washType = type;
            if (type === "정기세차") {
                document.getElementById("subscriptionBox").style.display = "block";
                bookingData.months = 1; // 기본 1개월
            } else {
                document.getElementById("subscriptionBox").style.display = "none";
                bookingData.months = null;
            }
            updateSummaryBar();
        }

        function updateSubscription(months) {
            bookingData.months = parseInt(months);
            updateSummaryBar();
        }

        function selectCourse(value) {
            bookingData.courseKey = value || null;

            if (value === "basic") {
                bookingData.course = courseInfo.basic.title;
                bookingData.courseDesc = courseInfo.basic.tagline;
            } else if (value === "premium") {
                bookingData.course = courseInfo.premium.title;
                bookingData.courseDesc = courseInfo.premium.tagline;
            } else {
                bookingData.course = "";
                bookingData.courseDesc = "";
            }
            updateSummaryBar(); // 선택 즉시 카드 갱신 & 금액 갱신
        }


        function toggleInterior() {
            bookingData.interior = document.getElementById("interiorOption").checked;
            updateSummaryBar();
        }

        function openCouponBox() {
            const myCoupons = [
                { code: "WELCOME10", discount: 0.1, text: "첫 구매 10%" },
                { code: "EVENT20", discount: 0.2, text: "이벤트 20%" }
            ];
            const best = myCoupons.reduce((a, b) => a.discount > b.discount ? a : b);
            bookingData.discountText = best.text;
            appliedDiscount = best.discount;
            alert(`${best.text} 쿠폰이 자동 적용되었습니다!`);
            updateSummaryBar();
        }
        //예약된 코스 설명
        function updateSummaryBar() {
            // 금액 계산
            let total = 0;
            if (bookingData.carSize) {
                let base = priceTable[bookingData.carSize]?.one || 30000;
                total = base;

                if (bookingData.washType === "정기세차" && bookingData.months) {
                    if (bookingData.months == 3) total = base * 3 * 0.95;
                    if (bookingData.months == 6) total = base * 6 * 0.9;
                    if (bookingData.months == 12) total = base * 12 * 0.8;
                    if (bookingData.months == 1) total = base;
                }

                // ✅ carSize가 priceTable에 없을 때 방어
                if (bookingData.interior && priceTable[bookingData.carSize]) {
                    total += priceTable[bookingData.carSize].interior;
                }

                if (appliedDiscount > 0) total *= (1 - appliedDiscount);
            }

            bookingData.finalPrice = total;

            // 코스 상세 카드 갱신
            renderCourseCard();
        }


        function renderCourseCard() {
            const key = bookingData.courseKey;
            const info = key ? courseInfo[key] : null;

            // 선택 안 했으면 카드 숨김
            if (!bookingData.washType && !bookingData.course && !bookingData.interior) {
                document.getElementById("courseDescription").innerHTML = "";
                return;
            }

            const size = bookingData.carSize;
            const time = info && size ? (info.timeBySize[size] || "") : "";
            const monthsText = bookingData.washType === "정기세차" && bookingData.months
                ? bookingData.months + "개월"
                : "";
            const optionText = bookingData.interior ? "실내세차 포함" : "";
            const discountText = bookingData.discountText || "";

            const includesHtml = info && info.includes.length
                ? info.includes.map(i => `<li>${i}</li>`).join("")
                : "";
            const notHtml = info && info.not_included.length
                ? info.not_included.map(i => `<li>${i}</li>`).join("")
                : "";
            const recommend = info ? info.recommend : "";

            // 카드 UI
            let html = `
      <div class="card shadow-sm border-0">
        <div class="card-body p-3">
          ${bookingData.course ? `<h6 class="card-title mb-1">${bookingData.course}</h6>` : ""}
          ${bookingData.courseDesc ? `<p class="card-subtitle text-muted small mb-2">${bookingData.courseDesc}</p>` : ""}
          ${recommend ? `<div class="small mb-2"><i class="bi bi-stars"></i> ${recommend}</div>` : ""}

          <div class="row g-2 small">
    `;

            if (includesHtml) {
                html += `
        <div class="col-12 col-md-6">
          <div class="border rounded p-2 h-100">
            <div class="fw-semibold mb-1">포함 항목</div>
            <ul class="mb-0 ps-3">${includesHtml}</ul>
          </div>
        </div>`;
            }

            if (notHtml) {
                html += `
        <div class="col-12 col-md-6">
          <div class="border rounded p-2 h-100">
            <div class="fw-semibold mb-1">미포함</div>
            <ul class="mb-0 ps-3">${notHtml}</ul>
          </div>
        </div>`;
            }

            html += `</div><hr class="my-2"><div class="d-flex flex-wrap gap-3 small">`;

            if (size) html += `<div><b>차량 크기:</b> ${size}</div>`;
            if (time) html += `<div><b>예상 소요:</b> ${time}</div>`;
            if (bookingData.washType) html += `<div><b>세차종류:</b> ${bookingData.washType}</div>`;
            if (monthsText) html += `<div><b>구독개월:</b> ${monthsText}</div>`;
            if (optionText) html += `<div><b>옵션:</b> ${optionText}</div>`;
            if (discountText) html += `<div><b>할인:</b> ${discountText}</div>`;

            html += `
          </div>
          ${bookingData.finalPrice ? `<div class="mt-2 fw-bold text-primary">최종 금액: ${bookingData.finalPrice.toLocaleString()}원</div>` : ""}
          <div class="text-muted small mt-1">※ 오염도/기상/차량 상태에 따라 작업 시간과 금액이 달라질 수 있습니다.</div>
        </div>
      </div>
    `;

            document.getElementById("courseDescription").innerHTML = html;
        }

        // === 여기쯤에 넣어주시면 돼요 ===

        // bookingData → Step3 UI 반영 함수
        function applyBookingDataToUI() {
            // 세차 종류 (radio)
            if (bookingData.washType) {
                document.querySelectorAll("input[name='washType']").forEach(radio => {
                    radio.checked = (radio.value === bookingData.washType);
                });
                selectWashType(bookingData.washType); // 구독박스 보이기/숨기기 처리
            }

            // 구독 개월 (select)
            if (bookingData.months) {
                document.getElementById("subscriptionSelect").value = bookingData.months;
            }

            // 코스 (select)
            if (bookingData.courseKey) {
                document.getElementById("courseSelect").value = bookingData.courseKey;
                selectCourse(bookingData.courseKey); // 코스 카드 업데이트
            }

            // 실내 옵션 (checkbox)
            document.getElementById("interiorOption").checked = !!bookingData.interior;

            // 최종 카드 갱신
            updateSummaryBar();
        }


        //캘린더 초기화
        function initCalendar() {
            const calendarEl = document.getElementById("calendar");
            if (!calendar) {
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: "dayGridMonth",
                    selectable: true,
                    dateClick: function (info) {
                        bookingData.date = info.dateStr;
                        renderTimeSlots(info.dateStr);
                    }

                });
                calendar.render();
            }
        }

        //캘린더 시간 버튼
        function renderTimeSlots(dateStr) {
            const slots = ["09:00", "11:00", "13:00", "15:00", "17:00"];
            const container = document.getElementById("timeSlots");
            container.innerHTML = "";
            slots.forEach(t => {
                const btn = document.createElement("button");
                btn.className = "btn btn-outline-primary m-1";
                btn.innerText = t;
                btn.onclick = () => {
                    bookingData.time = t;
                    document.querySelectorAll("#timeSlots button").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                };
                container.appendChild(btn);
            });
        }

        //예약확인
        function showSummary() {
            const summaryDiv = document.getElementById("summary");
            summaryDiv.innerHTML = `
        <p><b>예약자:</b> ${bookingData.name}</p>
        <p><b>연락처:</b> ${bookingData.phone}</p>
        <p><b>주소:</b> ${bookingData.address}</p>
        <p><b>차량:</b> ${bookingData.carNumber} - ${bookingData.carCompany} ${bookingData.carModel} (${bookingData.carSize})</p>
        <p><b>세차종류:</b> ${bookingData.washType}</p>
        <p><b>코스:</b> ${bookingData.course}</p>
        <p><b>옵션:</b> ${bookingData.interior ? "실내세차" : "없음"}</p>
        <p><b>날짜/시간:</b> ${bookingData.date} ${bookingData.time}</p>
        <p><b>최종금액:</b> <span class="fw-bold text-primary">${bookingData.finalPrice.toLocaleString()}원</span></p>
    `;
        }



        // 예약 확정
        function confirmBooking() {
            let bookings = JSON.parse(localStorage.getItem("bookings")) || [];
            const newBooking = { ...bookingData, status: "대기중" };
            bookings.push(newBooking);
            localStorage.setItem("bookings", JSON.stringify(bookings));

            let currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (!currentUser) {
                currentUser = {
                    name: bookingData.name,
                    phone: bookingData.phone,
                    address: bookingData.address,
                    addressDetail: document.getElementById("addressDetail").value,
                    cars: [],
                    history: []
                };
            }
            if (!currentUser.history) currentUser.history = [];

            // ✅ 필요한 값 모두 저장
            currentUser.history.push({
                date: new Date().toLocaleString(),
                washType: bookingData.washType,
                months: bookingData.months,
                courseKey: bookingData.courseKey,
                course: bookingData.course,
                carNumber: bookingData.carNumber,
                carCompany: bookingData.carCompany,
                carModel: bookingData.carModel,
                carSize: bookingData.carSize,
                dateStr: bookingData.date,
                time: bookingData.time,
                finalPrice: bookingData.finalPrice,
                detail: `${bookingData.course} - ${bookingData.date} ${bookingData.time}`
            });

            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            alert("예약이 완료되었습니다!");
            window.location.href = "index.html";
        }


        // 히스토리 모달 채우기
        document.getElementById("historyModal").addEventListener("show.bs.modal", () => {
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            const listDiv = document.getElementById("historyList");
            listDiv.innerHTML = "";
            if (!currentUser || !currentUser.history || currentUser.history.length === 0) {
                listDiv.innerHTML = "<p class='text-muted'>예약 기록이 없습니다.</p>";
                return;
            }

            currentUser.history.forEach((h) => {
                const card = document.createElement("div");
                card.className = "card mb-3 shadow-sm";
                card.style.cursor = "pointer";
                card.innerHTML = `
            <div class="card-body p-3">
                <div class="d-flex justify-content-between">
                    <h6 class="card-title mb-1">${h.course || "코스 미지정"}</h6>
                    <small class="text-muted">${h.date}</small>
                </div>
                <p class="card-subtitle text-muted small mb-2">
                    ${h.carNumber} - ${h.carCompany} ${h.carModel} (${h.carSize})
                </p>
                <p class="mb-1"><b>날짜/시간:</b> ${h.dateStr} ${h.time}</p>
                <p class="mb-0"><b>결제금액:</b> ${h.finalPrice?.toLocaleString() || 0}원</p>
            </div>
        `;
                card.onclick = () => {
                    document.getElementById("name").value = currentUser.name || "";
                    document.getElementById("phone").value = currentUser.phone || "";
                    document.getElementById("address").value = currentUser.address || "";
                    document.getElementById("addressDetail").value = currentUser.addressDetail || "";

                    bookingData = {
                        ...bookingData, ...h,
                        name: currentUser.name,
                        phone: currentUser.phone,
                        address: currentUser.address
                    };

                    // ✅ UI와 동기화
                    applyBookingDataToUI();

                    const now = new Date();
                    const selectedDate = new Date(`${h.dateStr} ${h.time}`);
                    if (!(selectedDate > now)) {
                        bookingData.date = "";
                        bookingData.time = "";
                        alert("과거 예약이므로 날짜/시간은 다시 선택해주세요.");
                    }
                    bootstrap.Modal.getInstance(document.getElementById("historyModal")).hide();
                    nextStep(4);
                    return;
                };

                listDiv.appendChild(card);
            });
        });

    </script>
</body>

</html>