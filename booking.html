<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARPOOOO - 세차 예약하기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <style>
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        /* 지도 */
        #map {
            width: 100%;
            height: 100vh;
        }


        /* 예약 패널 */
        #bookingPanel {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #fff;
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.25);
            overflow-y: auto;
            z-index: 1000;
            padding: 20px;

            min-height: 30vh;
            max-height: 100vh;
            height: 0;

            transform: translateY(100%);
            transition: transform 0.4s ease-in-out;
        }

        /* 예약 패널이 풀스크린일 때 GPS 버튼 숨김 */
        #bookingPanel.fullscreen~#recenterBtn {
            display: none;
        }

        #bookingPanel.active {
            transform: translateY(0);
        }

        /* 예약패널의 최대 높이 설정 */
        #bookingPanel.fullscreen {
            height: 90vh;
        }

        /* 기본 GPS 버튼 스타일 */
        #recenterBtn {
            position: absolute;
            bottom: 32%;
            left: 10px;
            z-index: 1200;
            background: #ffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 5px 10px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            font-size: 20px;
            color: #3f3f3f;
            cursor: pointer;
        }

        /*실시간 위치 표시*/
        .pulse-marker {
            width: 10px;
            height: 10px;
            background: red;
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(255, 0, 0, 0.6);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                transform: scale(1);
                background: rgba(255, 0, 0, 1);
            }

            50% {
                transform: scale(1.2);
                background: rgba(255, 0, 0, 1);
            }

            100% {
                transform: scale(1);
                background: rgba(255, 0, 0, 1);
            }
        }


        /* 스텝 전환 */
        .step {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        .step.active {
            display: block;
            opacity: 1;
        }

        /* 날짜 선택 바 */
        #dateBar {
            display: flex;
            gap: 10px;
            padding: 10px;
            overflow-x: auto;
            white-space: nowrap;
        }

        .date-item {
            flex: 0 0 auto;
            min-width: 60px;
            text-align: center;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f1f3f5;
            cursor: pointer;
        }

        .date-item.active {
            background: #29335a;
            color: #fff;
            font-weight: bold;
        }

        /* 시간 슬롯 버튼 */
        .slot-btn {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            width: 100%;
            cursor: pointer;
        }

        .slot-btn.active {
            border-color: #1a7aff;
            background: #eaf3ff;
        }

        .step {
            display: none;
            /* 기본적으로 숨김 */
        }

        .step.active {
            display: block;
            /* 현재 스텝만 보임 */
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <!-- 위치 갱신 버튼 -->
    <button id="recenterBtn">
        <i class="bi bi-crosshair"></i>
    </button>

    <!-- 예약 패널 -->
    <div id="bookingPanel">
        <div class="d-flex align-items-center justify-content-between mb-3">
            <div class="d-flex align-items-center">
                <!-- 뒤로가기 버튼 -->
                <button id="backBtn" class="border-0 bg-transparent p-0 me-2" style="font-size:20px; color:#333;">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <h5 class="mb-0">세차 예약하기</h5>
            </div>
        </div>

        <!-- Step1 -->
        <div class="step" id="step1">
            <h6>예약 날짜 & 시간</h6>
            <div id="dateBar" class="mb-3"></div>
            <div id="timeSlots" class="row g-2"></div>
        </div>

        <!-- Step2 -->
        <div class="step" id="step2">
            <h6>장소선택하기</h6>

            <div class="position-relative mb-2">
                <input type="text" class="form-control pe-4" id="address" placeholder="주소" readonly>
                <i class="bi bi-chevron-right position-absolute top-50 end-0 translate-middle-y me-2"
                    style="cursor:pointer" onclick="execDaumPostcode()"></i>
            </div>


            <div class="position-relative mb-2">
                <input type="text" class="form-control pe-4" id="addressDetail"
                    placeholder="차량상세위치(예: 00아파트 00동 지하 0층 0라인)" required>
                <i class="bi bi-chevron-right position-absolute top-50 end-0 translate-middle-y me-2"
                    style="cursor:pointer" onclick="confirmAddress()"></i>
            </div>

        </div>

        <div class="step" id="step3">
            <h6>차량 선택하기</h6>
            <div id="carList" class="row g-2"></div>
            <div id="noCarMessage" class="text-center text-muted" style="display:none;">
                등록된 차량이 없습니다.
            </div>
            <button class="btn btn-outline-primary w-100 mt-2" id="addCarBtn" style="display:none;">
                + 차량 등록하기
            </button>
        </div>


        <!-- Step4 -->
        <div class="step" id="step4">
            <h6>세차 코스 선택</h6>
            <input type="radio" name="washType" value="일반세차" onchange="selectWashType('일반세차')"> 일반세차
            <input type="radio" name="washType" value="정기세차" onchange="selectWashType('정기세차')"> 정기세차
            <select id="courseSelect" class="form-select mt-2" onchange="selectCourse(this.value)">
                <option value="">코스 선택</option>
                <option value="basic">베이직코스</option>
                <option value="premium">프리미엄코스</option>
            </select>
            <label class="mt-2"><input type="checkbox" id="interiorOption" onchange="toggleInterior()"> 실내세차
                추가</label>
            <div id="courseDescription" class="mt-3 text-muted small"></div>
            <button class="btn btn-primary mt-2" onclick="nextStep(4)">다음</button>
        </div>

        <!-- Step5 -->
        <div class="step" id="step5">
            <h6>예약 확인</h6>
            <div id="summary" class="border p-3 mb-3 bg-light"></div>
            <button class="btn btn-success float-end">결제하기</button>
        </div>

        <!-- 카카오 지도 SDK -->
        <script
            src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=83b11e1f0d4e9a629b1684b9f1c3392b&libraries=services"></script>

        <!-- Daum 주소검색 API -->
        <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
        <!-- carData & courseInfo -->
        <script src="carData.js"></script>
        <script src="courseInfo.js"></script>

        <script>
            let map, selectMarker, myMarker;
            let bookingData = {};
            let currentStep = 1;

            // 뒤로가기 버튼 이벤트
            document.getElementById("backBtn").addEventListener("click", () => {
                if (currentStep === 1) {
                    // Step1일 때 → 홈으로 이동
                    window.location.href = "index.html"; // <-- 홈경로
                } else {
                    // Step2 이상일 때 → 이전 step으로 이동
                    nextStep(currentStep - 1);
                }
            });


            window.onload = function () {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(initMap, showError, { enableHighAccuracy: true });
                } else {
                    alert("GPS를 지원하지 않습니다.");
                }

                //페이지 진입 시: 예약패널 열고 Step1부터 시작 (풀스크린)
                openBooking();
                nextStep(1);

                setTimeout(() => { if (map) map.relayout(); }, 500);
            };

            let geocoder = new kakao.maps.services.Geocoder();

            function initMap(pos) {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const locPosition = new kakao.maps.LatLng(lat, lon);

                const container = document.getElementById("map");
                map = new kakao.maps.Map(container, { center: locPosition, level: 3 });

                // 내 위치 마커 (깜빡이는 빨간 점)
                const markerContent = document.createElement("div");
                markerContent.className = "pulse-marker";

                myMarker = new kakao.maps.CustomOverlay({
                    position: locPosition,
                    content: markerContent,
                    yAnchor: 0.5,
                    xAnchor: 0.5
                });
                myMarker.setMap(map);

                // 선택 마커 (중앙 고정)
                selectMarker = new kakao.maps.Marker({
                    position: map.getCenter(),
                    map: map
                });

                function getAdjustedCenter() {
                    const center = map.getCenter();
                    const proj = map.getProjection();
                    const point = proj.containerPointFromCoords(center);

                    const panel = document.getElementById("bookingPanel");
                    let offsetY = 0;

                    // 패널이 fullscreen일 때는 보정하지 않음
                    if (!panel.classList.contains("fullscreen")) {
                        offsetY = panel.offsetHeight / 2;
                        point.y -= offsetY;
                    }

                    return proj.coordsFromContainerPoint(point);
                }

                // 선택 마커 업데이트
                function updateSelectMarker() {
                    const newPos = getAdjustedCenter();
                    selectMarker.setPosition(newPos);

                    bookingData.lat = newPos.getLat();
                    bookingData.lng = newPos.getLng();
                }

                kakao.maps.event.addListener(map, "center_changed", function () {
                    const newPos = getAdjustedCenter();
                    selectMarker.setPosition(newPos);
                    bookingData.lat = newPos.getLat();
                    bookingData.lng = newPos.getLng();

                    geocoder.coord2Address(newPos.getLng(), newPos.getLat(), function (result, status) {
                        if (status === kakao.maps.services.Status.OK) {
                            const roadAddr = result[0].road_address?.address_name;
                            const jibunAddr = result[0].address?.address_name;
                            document.getElementById("address").value = roadAddr || jibunAddr || "";
                            bookingData.address = roadAddr || jibunAddr || "";
                        }
                    });
                });


                bookingData.lat = lat;
                bookingData.lng = lon;

                document.getElementById("recenterBtn").addEventListener("click", () => {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(updateMyLocation, showError, { enableHighAccuracy: true });
                    }
                });
            }

            // 내 현재 위치 실시간 업데이트
            function updateMyLocation(pos) {
                const lat = pos.coords.latitude;
                const lon = pos.coords.longitude;
                const locPosition = new kakao.maps.LatLng(lat, lon);

                bookingData.lat = lat;
                bookingData.lng = lon;

                myMarker.setMap(null);
                myMarker = new kakao.maps.CustomOverlay({
                    position: locPosition,
                    content: '<div class="pulse-marker"></div>',
                    yAnchor: 0.5,
                    xAnchor: 0.5
                });
                myMarker.setMap(map);

                map.setCenter(locPosition);
            }


            // 오류 처리
            function showError(err) {
                alert("위치 정보를 가져올 수 없습니다: " + err.message);
            }

            function confirmAddress() {
                const addr = document.getElementById("address").value;
                const detail = document.getElementById("addressDetail").value;

                if (!addr) {
                    alert("주소를 선택해주세요.");
                    return;
                }
                if (!detail) {
                    alert("상세 주소를 입력해주세요.");
                    return;
                }

                bookingData.address = addr;
                bookingData.addressDetail = detail;

                nextStep(3);
            }
            function showCarList() {
                const carListDiv = document.getElementById("carList");
                const noCarMessage = document.getElementById("noCarMessage");
                const addCarBtn = document.getElementById("addCarBtn");

                carListDiv.innerHTML = "";

                const currentUser = JSON.parse(localStorage.getItem("currentUser")) || {};
                const cars = currentUser.cars || [];

                if (cars.length === 0) {
                    noCarMessage.style.display = "block";
                    addCarBtn.style.display = "block";
                    return;
                }

                addCarBtn.style.display = "block";

                cars.forEach((car) => {
                    const col = document.createElement("div");
                    col.className = "col-12 col-md-6 mb-3";

                    const card = document.createElement("div");
                    card.className = "car-card card shadow-sm border-0 rounded-3 overflow-hidden";
                    card.style.cursor = "pointer";

                    let imgSection = "";
                    if (car.carImage) {
                        // 이미지가 있는 경우
                        imgSection = `<img src="${car.carImage}" class="card-img-top" 
                        alt="차량 이미지" style="height:160px; object-fit:cover;">`;
                    } else {
                        // 이미지가 없는 경우 → 네이비색 배경
                        imgSection = `<div style="height:160px; background:#29335a; 
                        display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold;">
                        ${car.carNickname || car.carModel || "차량"}
                      </div>`;
                    }

                    card.innerHTML = `
        ${imgSection}
        <div class="card-body">
            <h6 class="fw-bold mb-1">${car.carNickname || car.carModel}</h6>
            <p class="mb-0 small text-muted">${car.carCompany} ${car.carModel}</p>
            <p class="mb-0 small">${car.carNumber}</p>
        </div>
    `;

                    card.onclick = () => {
                        bookingData.car = car;
                        nextStep(4);
                    };

                    col.appendChild(card);
                    carListDiv.appendChild(col);
                });
            }

            document.getElementById("addCarBtn").addEventListener("click", () => {
                window.location.href = "car-register.html"; // 차량 등록 페이지
            });



            // 차량 브랜드 드롭다운 채우기
            const brandSelect = document.getElementById("carCompany");
            const modelSelect = document.getElementById("carModel");
            for (let brand in carData) {
                let opt = document.createElement("option");
                opt.value = brand;
                opt.textContent = brand;
                brandSelect.appendChild(opt);
            }
            brandSelect.addEventListener("change", () => {
                modelSelect.innerHTML = "<option value=''>모델 선택</option>";
                if (brandSelect.value) {
                    Object.keys(carData[brandSelect.value]).forEach(size => {
                        carData[brandSelect.value][size].forEach(model => {
                            let opt = document.createElement("option");
                            opt.value = model;
                            opt.textContent = model;
                            modelSelect.appendChild(opt);
                        });
                    });
                }
            });
            modelSelect.addEventListener("change", () => {
                const brand = brandSelect.value;
                const model = modelSelect.value;
                let detectedSize = "";
                Object.keys(carData[brand]).forEach(size => {
                    if (carData[brand][size].includes(model)) detectedSize = size;
                });
                document.getElementById("carSizeBox").style.display = "block";
                document.getElementById("carSizeBox").innerText = "자동 분류된 차량 크기: " + detectedSize;
                bookingData.carSize = detectedSize;
            });

            // 패널 열기
            function openBooking() {
                const panel = document.getElementById("bookingPanel");
                panel.classList.add("active");
                panel.classList.remove("fullscreen");
            }

            function adjustPanelHeight() {
                const panel = document.getElementById("bookingPanel");
                const activeStep = panel.querySelector(".step.active");
                if (activeStep) {
                    // 현재 스텝 컨텐츠 실제 높이 + 패딩 보정
                    const contentHeight = activeStep.scrollHeight + 40;
                    panel.style.height = contentHeight + "px";
                }
            }

            function nextStep(step) {
                document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                document.getElementById('step' + step).classList.add('active');
                currentStep = step;

                const panel = document.getElementById("bookingPanel");
                const gpsBtn = document.getElementById("recenterBtn");

                if (step === 1 || step === 3 || step === 4 || step === 5) {
                    panel.classList.add("fullscreen");
                    gpsBtn.hidden = true;
                    panel.style.height = "90vh";   // 풀스크린은 고정
                } else {
                    panel.classList.remove("fullscreen");
                    gpsBtn.hidden = false;
                    adjustPanelHeight();           // 가변 높이로 transition
                }

                if (step === 1) initDateBar();
                if (step === 3) showCarList();
                if (step === 5) showSummary();
            }


            // 주소 검색
            function execDaumPostcode() {
                new daum.Postcode({
                    oncomplete: function (data) {
                        document.getElementById("address").value = data.address;
                    }
                }).open();
            }

            // 세차종류 & 코스 선택
            function selectWashType(type) {
                bookingData.washType = type;
            }
            function selectCourse(key) {
                bookingData.courseKey = key;
                if (key && courseInfo[key]) {
                    bookingData.course = courseInfo[key].title;
                    bookingData.courseDesc = courseInfo[key].tagline;
                    renderCourseCard();
                }
            }
            function toggleInterior() {
                bookingData.interior = document.getElementById("interiorOption").checked;
                renderCourseCard();
            }

            function initDateBar(days = 30) {
                const dateBar = document.getElementById("dateBar");
                dateBar.innerHTML = "";
                const today = new Date();

                for (let i = 0; i < days; i++) {
                    const d = new Date(today);
                    d.setDate(today.getDate() + i);

                    const div = document.createElement("div");
                    div.className = "date-item";
                    div.innerHTML = `
      <div>${d.getMonth() + 1}/${d.getDate()}</div>
      <div style="font-size:12px">${["일", "월", "화", "수", "목", "금", "토"][d.getDay()]}</div>
    `;

                    div.onclick = () => {
                        document.querySelectorAll(".date-item").forEach(el => el.classList.remove("active"));
                        div.classList.add("active");
                        bookingData.date = d.toISOString().split("T")[0];
                        renderTimeSlots(9, 22); // 09:00~22:00
                    };

                    if (i === 0) {
                        div.classList.add("active");
                        bookingData.date = d.toISOString().split("T")[0];
                    }

                    dateBar.appendChild(div);
                }

                renderTimeSlots(9, 22);
            }

            function renderTimeSlots(start = 9, end = 22) {
                const container = document.getElementById("timeSlots");
                container.innerHTML = "";

                for (let h = start; h <= end; h++) {
                    const col = document.createElement("div");
                    col.className = "col-6 col-md-3";

                    const btn = document.createElement("button");
                    btn.className = "slot-btn";
                    btn.innerText = h + ":00";

                    btn.onclick = () => {
                        bookingData.time = h + ":00";
                        document.querySelectorAll(".slot-btn").forEach(b => b.classList.remove("active"));
                        btn.classList.add("active");

                        nextStep(2);
                    };

                    col.appendChild(btn);
                    container.appendChild(col);
                }
            }



            // 코스 카드 렌더링
            function renderCourseCard() {
                const info = courseInfo[bookingData.courseKey];
                if (!info) return;
                let html = `<div class="card p-2"><h6>${info.title}</h6><p>${info.tagline}</p></div>`;
                document.getElementById("courseDescription").innerHTML = html;
            }

            // 예약 요약
            function showSummary() {
                const summary = document.getElementById("summary");
                summary.innerHTML = `
        <p><b>예약자:</b> ${document.getElementById("name").value}</p>
        <p><b>연락처:</b> ${document.getElementById("phone").value}</p>
        <p><b>주소:</b> ${document.getElementById("address").value} ${document.getElementById("addressDetail").value}</p>
        <p><b>세차종류:</b> ${bookingData.washType || "-"}</p>
        <p><b>코스:</b> ${bookingData.course || "-"}</p>
        <p><b>옵션:</b> ${bookingData.interior ? "실내세차" : "없음"}</p>
        <p><b>예약일시:</b> ${bookingData.date || "-"} ${bookingData.time || "-"}</p>
      `;
            }
        </script>
</body>

</html>