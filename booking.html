<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CARPOOOO - ì„¸ì°¨ ì˜ˆì•½í•˜ê¸°</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }

      /* ì§€ë„ */
      #map {
        width: 100%;
        height: 100vh;
      }

      /* ì˜ˆì•½ íŒ¨ë„ */
      #bookingPanel {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #fff;
        border-radius: 16px 16px 0 0;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.25);
        overflow-y: auto;
        z-index: 1000;
        padding: 20px;

        min-height: 30vh;
        max-height: 100vh;
        height: 0;

        transform: translateY(100%);
        transition: transform 0.4s ease-in-out;
      }

      /* ì˜ˆì•½ íŒ¨ë„ì´ í’€ìŠ¤í¬ë¦°ì¼ ë•Œ GPS ë²„íŠ¼ ìˆ¨ê¹€ */
      #bookingPanel.fullscreen ~ #recenterBtn {
        display: none;
      }

      #bookingPanel.active {
        transform: translateY(0);
      }

      /* ì˜ˆì•½íŒ¨ë„ì˜ ìµœëŒ€ ë†’ì´ ì„¤ì • */
      #bookingPanel.fullscreen {
        height: 100vh;
      }

      /* ê¸°ë³¸ GPS ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
      #recenterBtn {
        position: absolute;
        bottom: 32%;
        left: 10px;
        z-index: 1200;
        background: #ffff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 5px 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        font-size: 20px;
        color: #3f3f3f;
        cursor: pointer;
      }

      /*ì‹¤ì‹œê°„ ìœ„ì¹˜ í‘œì‹œ*/
      .pulse-marker {
        width: 10px;
        height: 10px;
        background: red;
        border-radius: 50%;
        box-shadow: 0 0 5px rgba(255, 0, 0, 0.6);
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          transform: scale(1);
          background: rgba(255, 0, 0, 1);
        }

        50% {
          transform: scale(1.2);
          background: rgba(255, 0, 0, 1);
        }

        100% {
          transform: scale(1);
          background: rgba(255, 0, 0, 1);
        }
      }

      /* ìŠ¤í… ì „í™˜ */
      .step {
        display: none;
        opacity: 0;
        transition: opacity 0.4s ease-in-out;
      }

      .step.active {
        display: block;
        opacity: 1;
      }

      /* ë‚ ì§œ ì„ íƒ ë°” */
      #dateBar {
        display: flex;
        gap: 10px;
        padding: 10px;
        overflow-x: auto;
        white-space: nowrap;
      }

      .date-item {
        flex: 0 0 auto;
        min-width: 60px;
        text-align: center;
        padding: 8px 12px;
        border-radius: 8px;
        background: #f1f3f5;
        cursor: pointer;
      }

      .date-item.active {
        background: #29335a;
        color: #fff;
        font-weight: bold;
      }

      /* ì‹œê°„ ìŠ¬ë¡¯ ë²„íŠ¼ */
      .slot-btn {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        width: 100%;
        cursor: pointer;
      }

      .slot-btn.active {
        border-color: #1a7aff;
        background: #eaf3ff;
      }

      .step {
        display: none;
        /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
      }

      .step.active {
        display: block;
        /* í˜„ì¬ ìŠ¤í…ë§Œ ë³´ì„ */
      }

      /*ì½”ìŠ¤ íŒì—… */
      .slot-btn {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .slot-btn:hover {
        border-color: #29335a;
        background: #eaf3ff;
      }

      .slot-btn.active {
        border-color: #29335a;
        background: #eaf3ff;
        font-weight: bold;
      }
      /*ìŠ¤í…5 ì „ìš© */
      #step5 .card {
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
      }
      #step5 h6 {
        color: #29335a;
      }
      #step5 .text-primary {
        color: #1a7aff;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
    <!-- ìœ„ì¹˜ ê°±ì‹  ë²„íŠ¼ -->
    <button id="recenterBtn">
      <i class="bi bi-crosshair"></i>
    </button>

    <!-- ì˜ˆì•½ íŒ¨ë„ -->
    <div id="bookingPanel">
      <div class="d-flex align-items-center justify-content-between mb-3">
        <div class="d-flex align-items-center">
          <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
          <button
            id="backBtn"
            class="border-0 bg-transparent p-0 me-2"
            style="font-size: 20px; color: #333"
            onclick="handleBack()"
          >
            <i class="bi bi-chevron-left"></i>
          </button>
          <h5 class="mb-0">ì„¸ì°¨ ì˜ˆì•½í•˜ê¸°</h5>
        </div>
      </div>

      <!-- Step1 -->
      <div class="step" id="step1">
        <h6>ì˜ˆì•½ ë‚ ì§œ & ì‹œê°„</h6>
        <div id="dateBar" class="mb-3"></div>
        <div id="timeSlots" class="row g-2"></div>
      </div>

      <!-- Step2 -->
      <div class="step" id="step2">
        <h6>ì¥ì†Œì„ íƒí•˜ê¸°</h6>

        <div class="position-relative mb-2">
          <input
            type="text"
            class="form-control pe-4"
            id="address"
            placeholder="ì£¼ì†Œ"
            readonly
          />
          <i
            class="bi bi-chevron-right position-absolute top-50 end-0 translate-middle-y me-2"
            style="cursor: pointer"
            onclick="execDaumPostcode()"
          ></i>
        </div>

        <div class="position-relative mb-2">
          <input
            type="text"
            class="form-control pe-4"
            id="addressDetail"
            placeholder="ì°¨ëŸ‰ìƒì„¸ìœ„ì¹˜(ì˜ˆ: 00ì•„íŒŒíŠ¸ 00ë™ ì§€í•˜ 0ì¸µ 0ë¼ì¸)"
            required
          />
          <i
            class="bi bi-chevron-right position-absolute top-50 end-0 translate-middle-y me-2"
            style="cursor: pointer"
            onclick="confirmAddress()"
          ></i>
        </div>
      </div>
      <!-- Step3 -->
      <div class="step" id="step3">
        <h6>ì°¨ëŸ‰ ì„ íƒí•˜ê¸°</h6>
        <div id="carList" class="row g-2"></div>
        <div
          id="noCarMessage"
          class="text-center text-muted"
          style="display: none"
        >
          ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.
        </div>
        <button
          class="btn btn-outline-primary w-100 mt-2"
          id="addCarBtn"
          style="display: none"
        >
          + ì°¨ëŸ‰ ë“±ë¡í•˜ê¸°
        </button>
      </div>

      <!-- Step4 -->
      <div class="step" id="step4">
        <h6>ì„¸ì°¨ ì½”ìŠ¤ ì„ íƒ</h6>

        <!-- ì„¸ì°¨ì¢…ë¥˜ -->
        <div id="accordionWash">
          <p class="fw-bold mb-2">ì„¸ì°¨ì¢…ë¥˜ì„ íƒ</p>
          <div class="row g-2">
            <div class="col-6">
              <button
                class="slot-btn w-100"
                onclick="chooseWash('ì¼ë°˜ì„¸ì°¨', event)"
              >
                ì¼ë°˜ì„¸ì°¨ (1íšŒ)
              </button>
            </div>
            <div class="col-6">
              <button
                class="slot-btn w-100"
                onclick="chooseWash('ì •ê¸°ì„¸ì°¨', event)"
              >
                ì •ê¸°ì„¸ì°¨
              </button>
            </div>
          </div>

          <!-- ì •ê¸°ì„¸ì°¨ êµ¬ë…ê¶Œ -->
          <div id="subWashOptions" class="row g-2 mt-2 d-none">
            <div class="col-6">
              <button
                class="slot-btn w-100"
                onclick="chooseSubWash('1ê°œì›”ê¶Œ',0,event)"
              >
                1ê°œì›”ê¶Œ
              </button>
            </div>
            <div class="col-6">
              <button
                class="slot-btn w-100"
                onclick="chooseSubWash('3ê°œì›”ê¶Œ',10,event)"
              >
                3ê°œì›”ê¶Œ
              </button>
            </div>
            <div class="col-6">
              <button
                class="slot-btn w-100"
                onclick="chooseSubWash('6ê°œì›”ê¶Œ',15,event)"
              >
                6ê°œì›”ê¶Œ
              </button>
            </div>
            <div class="col-6">
              <button
                class="slot-btn w-100"
                onclick="chooseSubWash('12ê°œì›”ê¶Œ',20,event)"
              >
                12ê°œì›”ê¶Œ
              </button>
            </div>
          </div>
        </div>

        <!-- ì„¸ì°¨ì˜µì…˜ -->
        <div id="accordionOption" class="mt-3">
          <p class="fw-bold mb-2">ì„¸ì°¨ì˜µì…˜ì„ íƒ</p>
          <div class="row g-2">
            <div class="col-6">
              <button
                class="slot-btn w-100"
                onclick="chooseOption(false, event)"
              >
                ì„ íƒì•ˆí•¨
              </button>
            </div>
            <div class="col-6">
              <button
                class="slot-btn w-100"
                onclick="chooseOption(true, event)"
              >
                ë‚´ë¶€ì„¸ì°¨ ì¶”ê°€
              </button>
            </div>
          </div>
        </div>

        <!-- ìƒì„¸ ì„¤ëª… -->
        <div id="courseDescription" class="mt-3 text-muted small"></div>

        <!-- ë‹¤ìŒ ë²„íŠ¼ -->
        <button
          class="btn btn-primary mt-3 w-100"
          id="step4NextBtn"
          disabled
          onclick="nextStep(5)"
        >
          ë‹¤ìŒ
        </button>
      </div>

      <!-- Step5 ë‚´ë¶€ -->
      <div class="step fullscreen" id="step5">
        <div class="d-flex align-items-center border-bottom pb-2 mb-3">
          <button
            class="border-0 bg-transparent me-2"
            style="font-size: 20px"
            onclick="nextStep(4)"
          ></button>
          <h5 class="mb-0 fw-">ì˜ˆì•½ í™•ì¸ ë° ê²°ì œí•˜ê¸°</h5>
        </div>

        <!-- ìŠ¤í¬ë¡¤ ì½˜í…ì¸  -->
        <div
          class="content-area"
          style="overflow-y: auto; padding-bottom: 120px"
        >
          <!-- ğŸ”¹ ê¸°ì¡´ Step5 ë‚´ìš© -->
          <!-- ì°¨ëŸ‰ ì •ë³´ -->
          <div id="selectedCarCard" class="card mb-3 shadow-sm"></div>

          <!-- ì˜ˆì•½ì¼ì‹œ -->
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <h6 class="fw-bold mb-2">ì˜ˆì•½ì¼ì‹œ</h6>
              <p class="mb-0">
                <span id="summaryDate"></span> <span id="summaryTime"></span>
              </p>
            </div>
          </div>

          <!-- ì¥ì†Œ -->
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <h6 class="fw-bold mb-2">ì„¸ì°¨ ì¥ì†Œ</h6>
              <p class="mb-0" id="summaryAddress"></p>
            </div>
          </div>

          <!-- ì„¸ì°¨ ì½”ìŠ¤ -->
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <h6 class="fw-bold mb-2">ì„¸ì°¨ ì½”ìŠ¤</h6>
              <p class="mb-1" id="summaryWashType"></p>
              <p class="mb-0">ë‚´ë¶€ì„¸ì°¨: <span id="summaryOption"></span></p>
            </div>
          </div>

          <!-- ê²°ì œ ìˆ˜ë‹¨ -->
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <h6 class="fw-bold mb-3">ê²°ì œ ìˆ˜ë‹¨</h6>
              <div class="row g-2">
                <div class="col-6">
                  <button
                    class="slot-btn w-100"
                    onclick="choosePayment('naver', event)"
                  >
                    ë„¤ì´ë²„í˜ì´
                  </button>
                </div>
                <div class="col-6">
                  <button
                    class="slot-btn w-100"
                    onclick="choosePayment('card', event)"
                  >
                    ì¹´ë“œê²°ì œ
                  </button>
                </div>
              </div>
            </div>
          </div>

          <!-- ğŸ”¹ ì‹ ê·œ ì¶”ê°€: ê²°ì œ ê¸ˆì•¡ Breakdown -->
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <h6 class="fw-bold mb-3">ê²°ì œ ê¸ˆì•¡</h6>

              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">ìš”ê¸ˆ í•©ê³„</span>
                <span id="summaryTotalPrice">0ì›</span>
              </div>

              <div class="ps-2">
                <div class="d-flex justify-content-between mb-1">
                  <span>ì°¨ëŸ‰ ê¸°ë³¸ê°€ê²©</span><span id="priceBase">0ì›</span>
                </div>
                <div class="d-flex justify-content-between mb-1">
                  <span>ìˆ˜ì…ì°¨ ì¶”ê°€ê¸ˆ</span><span id="priceImport">0ì›</span>
                </div>
                <div class="d-flex justify-content-between mb-1">
                  <span>SUV ì¶”ê°€ê¸ˆ</span><span id="priceSUV">0ì›</span>
                </div>
                <div class="d-flex justify-content-between mb-1">
                  <span>ì½”ìŠ¤ ìš”ê¸ˆ</span><span id="priceCourse">0ì›</span>
                </div>
                <div class="d-flex justify-content-between mb-1">
                  <span>ì˜µì…˜ ìš”ê¸ˆ</span><span id="priceOption">0ì›</span>
                </div>
              </div>
            </div>
          </div>

          <!-- í• ì¸ í•©ê³„ -->
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <h6 class="fw-bold mb-3">í• ì¸ í•©ê³„</h6>
              <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">ì¿ í°</span>
                <span id="discountCoupon">-0ì›</span>
              </div>
              <div class="d-flex justify-content-between">
                <span class="text-muted">í¬ë ˆë”§</span>
                <span id="discountCredit">-0ì›</span>
              </div>
            </div>
          </div>

          <!-- ì´ ê²°ì œ ê¸ˆì•¡ -->
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <div class="d-flex justify-content-between mb-2">
                <h6 class="fw-bold">ì´ ê²°ì œ ê¸ˆì•¡</h6>
                <h6 class="fw-bold text-primary" id="finalAmount">0ì›</h6>
              </div>
              <p class="mb-0 text-muted small">
                ì ë¦½ ì˜ˆì • í¬ë ˆë”§ <span id="expectedCredit">0</span> í¬ë ˆë”§
              </p>
            </div>
          </div>

          <!-- ì˜ˆì•½ ì „ ì£¼ì˜ì‚¬í•­ -->
          <div class="card mb-3 shadow-sm">
            <div class="card-body">
              <h6 class="fw-bold mb-2">ì˜ˆì•½ ì „ ì£¼ì˜ì‚¬í•­</h6>
              <p class="mb-1 text-muted small">
                â€¢ ì·¨ì†Œ ì‹œì ì— ë”°ë¼ ì·¨ì†Œ ìˆ˜ìˆ˜ë£Œê°€ ë¶€ê³¼ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
              </p>
              <p class="mb-0 text-muted small">
                â€¢ ì´ìš© ì•½ê´€ì„ ë°˜ë“œì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.
              </p>
            </div>
          </div>

          <!-- ì•½ê´€ ë™ì˜ -->
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="agreeCheck" />
            <label class="form-check-label small text-muted" for="agreeCheck">
              ì•½ê´€ ë° ì´ìš© ì•ˆë‚´ì— ë™ì˜í•©ë‹ˆë‹¤.
            </label>
          </div>
        </div>
      </div>
    </div>
    <div
      id="step5Footer"
      class="fixed-bottom bg-white border-top d-flex justify-content-between align-items-center p-3 shadow-sm d-none"
      style="z-index: 2000"
    >
      <h5 class="mb-0 fw-bold">â‚© <span id="bottomFinalPrice">0</span></h5>
      <button
        class="btn btn-primary px-4 py-2"
        id="payBtn"
        disabled
        onclick="submitPayment()"
      >
        ê²°ì œí•˜ê¸°
      </button>
    </div>

    <!-- ì¹´ì¹´ì˜¤ ì§€ë„ SDK -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=83b11e1f0d4e9a629b1684b9f1c3392b&libraries=services"></script>

    <!-- Daum ì£¼ì†Œê²€ìƒ‰ API -->
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <!-- carData & courseInfo -->
    <script src="carData.js"></script>
    <script src="courseInfo.js"></script>

    <script>
      function handleBack() {
        if (currentStep === 1) {
          // ìŠ¤í…1 â†’ í™ˆ
          window.location.href = "index.html";
        } else {
          // ê·¸ ì™¸ â†’ ì´ì „ ìŠ¤í…ìœ¼ë¡œ
          nextStep(currentStep - 1);
        }
      }

      let map, selectMarker, myMarker;
      let bookingData = {};
      let currentStep = 1;
      let selectedPayment = null;

      window.onload = function () {
        // ê¸°ì¡´ ì˜ˆì•½ ë°ì´í„° ë³µì›
        const savedBooking = localStorage.getItem("tempBookingData");
        if (savedBooking) {
          bookingData = JSON.parse(savedBooking);
          localStorage.removeItem("tempBookingData"); // í•œ ë²ˆ ì“°ë©´ ì§€ì›Œì¤Œ
        }

        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(initMap, showError, {
            enableHighAccuracy: true,
          });
        } else {
          alert("GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
        openBooking();

        // step=3ìœ¼ë¡œ ë°”ë¡œ ì´ë™í•  ìˆ˜ ìˆë„ë¡ ì¿¼ë¦¬ ì²˜ë¦¬
        const urlParams = new URLSearchParams(window.location.search);
        const step = urlParams.get("step");
        nextStep(step ? parseInt(step) : 1);
      };

      function initMap(pos) {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const locPosition = new kakao.maps.LatLng(lat, lon);
        map = new kakao.maps.Map(document.getElementById("map"), {
          center: locPosition,
          level: 3,
        });

        // ë‚´ ìœ„ì¹˜ ë§ˆì»¤
        const markerContent = document.createElement("div");
        markerContent.className = "pulse-marker";
        myMarker = new kakao.maps.CustomOverlay({
          position: locPosition,
          content: markerContent,
          yAnchor: 0.5,
          xAnchor: 0.5,
        });
        myMarker.setMap(map);

        // ì„ íƒ ë§ˆì»¤ (ì¤‘ì•™ ê¸°ì¤€)
        selectMarker = new kakao.maps.Marker({
          position: map.getCenter(),
          map: map,
        });

        // âœ… ì¤‘ì‹¬ ì¢Œí‘œ ë³´ì • í•¨ìˆ˜
        function getAdjustedCenter() {
          const center = map.getCenter();
          const proj = map.getProjection();
          const point = proj.containerPointFromCoords(center);

          const panel = document.getElementById("bookingPanel");
          let offsetY = 0;

          if (!panel.classList.contains("fullscreen")) {
            offsetY = panel.offsetHeight / 2;
            point.y -= offsetY;
          }
          return proj.coordsFromContainerPoint(point);
        }

        kakao.maps.event.addListener(map, "center_changed", function () {
          const newPos = getAdjustedCenter();
          selectMarker.setPosition(newPos);

          bookingData.lat = newPos.getLat();
          bookingData.lng = newPos.getLng();

          // ì—­ì§€ì˜¤ì½”ë”© â†’ ì£¼ì†Œ ìë™ ì…ë ¥
          const geocoder = new kakao.maps.services.Geocoder();
          geocoder.coord2Address(
            newPos.getLng(),
            newPos.getLat(),
            function (result, status) {
              if (status === kakao.maps.services.Status.OK) {
                const roadAddr = result[0].road_address?.address_name;
                const jibunAddr = result[0].address?.address_name;
                document.getElementById("address").value =
                  roadAddr || jibunAddr || "";
                bookingData.address = roadAddr || jibunAddr || "";
              }
            }
          );
        });
      }

      // íŒ¨ë„ ì—´ê¸°
      function openBooking() {
        const panel = document.getElementById("bookingPanel");
        panel.classList.add("active");
        panel.classList.remove("fullscreen");
      }

      // íŒ¨ë„ ë†’ì´ ì¡°ì •
      function adjustPanelHeight() {
        const panel = document.getElementById("bookingPanel");
        const activeStep = panel.querySelector(".step.active");
        if (activeStep) {
          let contentHeight = activeStep.scrollHeight + 40;
          if (contentHeight < window.innerHeight * 0.4) {
            contentHeight = window.innerHeight * 0.4;
          }
          if (contentHeight > window.innerHeight) {
            contentHeight = window.innerHeight;
            panel.style.overflowY = "auto";
          } else {
            panel.style.overflowY = "hidden";
          }
          panel.style.height = contentHeight + "px";
        }
      }

      function nextStep(step) {
        document
          .querySelectorAll(".step")
          .forEach((s) => s.classList.remove("active"));
        document.getElementById("step" + step).classList.add("active");
        currentStep = step;

        const panel = document.getElementById("bookingPanel");
        const gpsBtn = document.getElementById("recenterBtn");
        const footer = document.getElementById("step5Footer");

        if (step === 1 || step === 2 || step === 4) {
          panel.classList.remove("fullscreen");
          panel.style.height = "auto";
          gpsBtn.hidden = step === 2 ? false : true;
          footer.classList.add("d-none");
          if (step === 1) initDateBar();
        } else if (step === 3) {
          panel.classList.remove("fullscreen");
          gpsBtn.hidden = true;
          footer.classList.add("d-none");
          showCarList();
          adjustPanelHeight();
        } else if (step === 5) {
          panel.classList.add("fullscreen");
          panel.style.height = "100vh";
          panel.style.overflowY = "auto"; // âœ… Step5ëŠ” ìŠ¤í¬ë¡¤ ê°€ëŠ¥í•˜ê²Œ
          gpsBtn.hidden = true;
          footer.classList.remove("d-none");
          showSummary();
        }
      }

      // ì‹¤ì‹œê°„ ìœ„ì¹˜ ê°±ì‹  ë²„íŠ¼ ì´ë²¤íŠ¸
      document.getElementById("recenterBtn").addEventListener("click", () => {
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            updateMyLocation,
            showError,
            {
              enableHighAccuracy: true,
            }
          );
        } else {
          alert("GPSë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
        }
      });

      function updateMyLocation(pos) {
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        const locPosition = new kakao.maps.LatLng(lat, lon);

        bookingData.lat = lat;
        bookingData.lng = lon;

        if (myMarker) myMarker.setMap(null);
        myMarker = new kakao.maps.CustomOverlay({
          position: locPosition,
          content: '<div class="pulse-marker"></div>',
          yAnchor: 0.5,
          xAnchor: 0.5,
        });
        myMarker.setMap(map);

        map.setCenter(locPosition);

        if (selectMarker) {
          selectMarker.setPosition(locPosition);
        }
      }

      // ì˜¤ë¥˜ ì²˜ë¦¬
      function showError(err) {
        alert("ìœ„ì¹˜ ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: " + err.message);
      }

      // ================= ë‚ ì§œ & ì‹œê°„ =================
      function initDateBar(days = 30) {
        const dateBar = document.getElementById("dateBar");
        dateBar.innerHTML = "";
        const today = new Date();

        for (let i = 0; i < days; i++) {
          const d = new Date(today);
          d.setDate(today.getDate() + i);
          const div = document.createElement("div");
          div.className = "date-item";
          div.innerHTML = `<div>${d.getMonth() + 1}/${d.getDate()}</div>
                         <div style="font-size:12px">${
                           ["ì¼", "ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† "][
                             d.getDay()
                           ]
                         }</div>`;
          div.onclick = () => {
            document
              .querySelectorAll(".date-item")
              .forEach((el) => el.classList.remove("active"));
            div.classList.add("active");
            bookingData.date = d.toISOString().split("T")[0];
            renderTimeSlots(9, 22);
          };
          if (i === 0) {
            div.classList.add("active");
            bookingData.date = d.toISOString().split("T")[0];
          }
          dateBar.appendChild(div);
        }
        renderTimeSlots(9, 22);
      }

      function renderTimeSlots(start, end) {
        const container = document.getElementById("timeSlots");
        container.innerHTML = "";
        for (let h = start; h <= end; h++) {
          const col = document.createElement("div");
          col.className = "col-6 col-md-3";
          const btn = document.createElement("button");
          btn.className = "slot-btn";
          btn.innerText = h + ":00";
          btn.onclick = () => {
            bookingData.time = h + ":00";
            document
              .querySelectorAll(".slot-btn")
              .forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");
            nextStep(2);
          };
          col.appendChild(btn);
          container.appendChild(col);
        }
      }

      // ================= ì£¼ì†Œê²€ìƒ‰ & Step2 â†’ Step3 ì´ë™ =================
      function execDaumPostcode() {
        new daum.Postcode({
          oncomplete: function (data) {
            document.getElementById("address").value =
              data.roadAddress || data.jibunAddress;
            bookingData.address = data.roadAddress || data.jibunAddress;
          },
        }).open();
      }

      function confirmAddress() {
        const addr = document.getElementById("address").value;
        const detail = document.getElementById("addressDetail").value;

        if (!addr) {
          alert("ì£¼ì†Œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }
        if (!detail) {
          alert("ìƒì„¸ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
          return;
        }

        bookingData.address = addr;
        bookingData.addressDetail = detail;

        nextStep(3);
      }

      // ================= ì°¨ëŸ‰ =================
      function showCarList() {
        const carListDiv = document.getElementById("carList");
        const noCarMessage = document.getElementById("noCarMessage");
        const addCarBtn = document.getElementById("addCarBtn");

        carListDiv.innerHTML = "";
        const currentUser =
          JSON.parse(localStorage.getItem("currentUser")) || {};
        const cars = currentUser.cars || [];

        if (cars.length === 0) {
          noCarMessage.style.display = "block";
        } else {
          noCarMessage.style.display = "none";

          cars.forEach((car) => {
            const col = document.createElement("div");
            col.className = "col-12 col-md-6 mb-3";

            const card = document.createElement("div");
            card.className =
              "car-card card shadow-sm border-0 rounded-3 overflow-hidden";
            card.style.cursor = "pointer";

            let imgSection = "";
            if (car.carImage) {
              imgSection = `<img src="${car.carImage}" class="card-img-top"
                             style="height:160px; object-fit:cover;">`;
            } else {
              imgSection = `<div style="height:160px; background:#29335a;
                             display:flex; align-items:center; justify-content:center; color:#fff; font-weight:bold;">
                             ${car.carNickname || car.carModel || "ì°¨ëŸ‰"}
                            </div>`;
            }

            card.innerHTML = `${imgSection}
              <div class="card-body">
                <h6 class="fw-bold mb-1">${car.carNickname || car.carModel}</h6>
                <p class="mb-0 small text-muted">${car.carCompany} ${
              car.carModel
            }</p>
                <p class="mb-0 small">${car.carNumber}</p>
              </div>`;

            card.onclick = () => {
              bookingData.car = car;
              nextStep(4);
            };

            col.appendChild(card);
            carListDiv.appendChild(col);
          });
        }

        addCarBtn.style.display = "block";
        const col = document.createElement("div");
        col.className = "col-12 mb-5";
        col.appendChild(addCarBtn);
        carListDiv.appendChild(col);

        // ë“±ë¡ í˜ì´ì§€ ì´ë™
        addCarBtn.onclick = () => {
          // í˜„ì¬ ì˜ˆì•½ ë°ì´í„° ì„ì‹œ ì €ì¥
          localStorage.setItem("tempBookingData", JSON.stringify(bookingData));

          // ì°¨ëŸ‰ ë“±ë¡ í˜ì´ì§€ë¡œ ì´ë™ (ì˜ˆì•½ì—ì„œ í˜¸ì¶œ)
          window.location.href = "car-register.html?from=booking";
        };
      }

      // ================= ì½”ìŠ¤ ì„ íƒ =================

      // ì„¸ì°¨ ì¢…ë¥˜ ì„ íƒ
      function chooseWash(type, e) {
        bookingData.washType = type;
        bookingData.subWash = null; // ì´ˆê¸°í™”
        bookingData.discount = 0;

        // ë²„íŠ¼ active í‘œì‹œ
        document
          .querySelectorAll("#accordionWash .slot-btn")
          .forEach((btn) => btn.classList.remove("active"));
        e.target.classList.add("active");

        // ì •ê¸°ì„¸ì°¨ ì„ íƒ ì‹œ êµ¬ë…ê¶Œ ì˜µì…˜ ë³´ì´ê¸°
        const subWashOptions = document.getElementById("subWashOptions");
        if (type === "ì •ê¸°ì„¸ì°¨") {
          subWashOptions.classList.remove("d-none");
        } else {
          subWashOptions.classList.add("d-none");
        }

        // ìƒì„¸ ì„¤ëª… ì—…ë°ì´íŠ¸
        document.getElementById("courseDescription").textContent =
          type === "ì •ê¸°ì„¸ì°¨"
            ? "ì •ê¸°ì„¸ì°¨ êµ¬ë…ê¶Œì„ ì„ íƒí•´ì£¼ì„¸ìš”."
            : "ì¼ë°˜ì„¸ì°¨ 1íšŒ ì½”ìŠ¤ê°€ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤.";

        updateStep4Next();
      }

      // ì •ê¸°ì„¸ì°¨ êµ¬ë…ê¶Œ ì„ íƒ
      function chooseSubWash(name, discount, e) {
        bookingData.subWash = name;
        bookingData.discount = discount;

        document
          .querySelectorAll("#subWashOptions .slot-btn")
          .forEach((btn) => btn.classList.remove("active"));
        e.target.classList.add("active");

        document.getElementById(
          "courseDescription"
        ).textContent = `${name} êµ¬ë…ê¶Œì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. (${discount}% í• ì¸ ì ìš©)`;

        updateStep4Next();
      }

      // ì˜µì…˜ ì„ íƒ (ë‚´ë¶€ì„¸ì°¨)
      function chooseOption(addInterior, e) {
        bookingData.interior = addInterior;

        document
          .querySelectorAll("#accordionOption .slot-btn")
          .forEach((btn) => btn.classList.remove("active"));
        e.target.classList.add("active");

        document.getElementById("courseDescription").textContent = addInterior
          ? "ë‚´ë¶€ì„¸ì°¨ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤."
          : "ë‚´ë¶€ì„¸ì°¨ ì˜µì…˜ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";

        updateStep4Next();
      }

      // Step4 'ë‹¤ìŒ' ë²„íŠ¼ í™œì„±í™” ì—¬ë¶€ ê°±ì‹ 
      function updateStep4Next() {
        const nextBtn = document.getElementById("step4NextBtn");

        if (bookingData.washType === "ì •ê¸°ì„¸ì°¨") {
          // ì •ê¸°ì„¸ì°¨ëŠ” êµ¬ë…ê¶Œê¹Œì§€ ê³¨ë¼ì•¼ í™œì„±í™”
          nextBtn.disabled = !bookingData.subWash;
        } else {
          // ì¼ë°˜ì„¸ì°¨ëŠ” ì„¸ì°¨ ì¢…ë¥˜ë§Œ ì„ íƒí•˜ë©´ í™œì„±í™”
          nextBtn.disabled = !bookingData.washType;
        }
      }

      // ================= ê²°ì œ =================
      function calculateTotal() {
        const size = bookingData.carSize || "ì¤‘í˜•";
        let base = courseInfo.basePrice[size] || 30000;
        let importFee = bookingData.car?.isImported ? 10000 : 0;
        let suvFee = bookingData.car?.isSUV ? 5000 : 0;
        let optionFee = bookingData.interior ? courseInfo.options.interior : 0;
        let subtotal = base + importFee + suvFee + optionFee;
        let discountCoupon = bookingData.coupon || 0;
        let discountCredit = bookingData.credit || 0;
        let discountTotal = discountCoupon + discountCredit;
        let total = subtotal - discountTotal;

        document.getElementById("priceBase").textContent =
          base.toLocaleString() + "ì›";
        document.getElementById("priceImport").textContent =
          importFee.toLocaleString() + "ì›";
        document.getElementById("priceSUV").textContent =
          suvFee.toLocaleString() + "ì›";
        document.getElementById("priceCourse").textContent =
          base.toLocaleString() + "ì›";
        document.getElementById("priceOption").textContent =
          optionFee.toLocaleString() + "ì›";
        document.getElementById("discountCoupon").textContent =
          "-" + discountCoupon.toLocaleString() + "ì›";
        document.getElementById("discountCredit").textContent =
          "-" + discountCredit.toLocaleString() + "ì›";

        bookingData.totalPrice = total;
        return total;
      }

      function showSummary() {
        const car = bookingData.car;
        document.getElementById("selectedCarCard").innerHTML = `
        <div class="card-body d-flex align-items-center">
          ${
            car?.carImage
              ? `<img src="${car.carImage}" style="width:80px;height:60px;object-fit:cover;border-radius:8px;margin-right:10px;">`
              : `<div style="width:80px;height:60px;background:#29335a;border-radius:8px;margin-right:10px;"></div>`
          }
          <div>
            <h6 class="mb-1">${car?.carNickname || car?.carModel || ""}</h6>
            <p class="mb-0 small text-muted">${car?.carCompany || ""} ${
          car?.carModel || ""
        }</p>
            <p class="mb-0 small">${car?.carNumber || ""}</p>
          </div>
        </div>`;

        document.getElementById("summaryDate").textContent =
          bookingData.date || "-";
        document.getElementById("summaryTime").textContent =
          bookingData.time || "-";
        document.getElementById("summaryAddress").textContent =
          (bookingData.address || "") + " " + (bookingData.addressDetail || "");
        let washTypeText = bookingData.washType || "-";
        if (bookingData.subWash)
          washTypeText += ` (${bookingData.subWash}, ${bookingData.discount}% í• ì¸)`;
        document.getElementById("summaryWashType").textContent = washTypeText;
        document.getElementById("summaryOption").textContent =
          bookingData.interior ? "ì¶”ê°€" : "ì—†ìŒ";

        const total = calculateTotal();
        document.getElementById("finalAmount").textContent =
          total.toLocaleString() + "ì›";
        document.getElementById("bottomFinalPrice").textContent =
          total.toLocaleString();
        document.getElementById("summaryTotalPrice").textContent =
          total.toLocaleString() + "ì›";
      }

      function choosePayment(method, e) {
        document
          .querySelectorAll("#step5 .slot-btn")
          .forEach((btn) => btn.classList.remove("active"));
        e.target.classList.add("active");
        selectedPayment = method;
        updatePayButtonState();
      }

      function updatePayButtonState() {
        const isAgreed = document.getElementById("agreeCheck").checked;
        document.getElementById("payBtn").disabled = !(
          isAgreed && selectedPayment
        );
      }

      function submitPayment() {
        alert(
          `ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nê²°ì œìˆ˜ë‹¨: ${
            selectedPayment === "naver" ? "ë„¤ì´ë²„í˜ì´" : "ì¹´ë“œê²°ì œ"
          }\nê²°ì œê¸ˆì•¡: â‚©${bookingData.totalPrice.toLocaleString()}`
        );

        let currentUser = JSON.parse(localStorage.getItem("currentUser")) || {};
        if (!currentUser.history) currentUser.history = [];

        const record = {
          course: bookingData.washType || "ì„¸ì°¨ ì½”ìŠ¤",
          washType: bookingData.washType,
          subWash: bookingData.subWash,
          months: bookingData.subWash ? parseInt(bookingData.subWash) : 0,
          carCompany: bookingData.car?.carCompany,
          carModel: bookingData.car?.carModel,
          carNumber: bookingData.car?.carNumber,
          carSize: bookingData.carSize,
          isImported: bookingData.car?.isImported,
          isSUV: bookingData.car?.isSUV,
          dateStr: bookingData.date,
          time: bookingData.time,
          address: bookingData.address,
          addressDetail: bookingData.addressDetail,
          finalPrice: bookingData.totalPrice,
          status: "ì˜ˆì•½í™•ì •",
        };

        currentUser.history.push(record);
        localStorage.setItem("currentUser", JSON.stringify(currentUser));

        window.location.href = "index.html";
      }

      document
        .getElementById("agreeCheck")
        .addEventListener("change", updatePayButtonState);
    </script>
  </body>
</html>
