<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARPOOOO - ì„¸ì°¨ ì˜ˆì•½í•˜ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link href="booking.css" rel="stylesheet">
    <style>
        body.booking .header {
            background: #1a7aff;
            color: #000;
            border-bottom: 1px solid #eee;
        }

        body.booking .header h4 {
            color: #000;
            font-size: 20px;
        }

        .step {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        .step.active {
            display: block;
            opacity: 1;
        }

        #calendar {
            min-height: 500px;
            margin: 20px 0;
        }

        /*ìƒˆë¡œ ì¶”ê°€í•œ ìº˜ë¦°ë” ì„¤ì •*/
        /* ë‚ ì§œ ë°” */
        #dateBar {
            display: flex;
            gap: 10px;
            padding: 10px 0;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            /* ëª¨ë°”ì¼ ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
            max-width: 100%;
            /* ë°˜ë“œì‹œ ë¶€ëª¨ ë„ˆë¹„ ì œí•œ */
        }

        .date-item {
            flex: 0 0 auto;
            text-align: center;
            padding: 8px 12px;
            border-radius: 8px;
            background: #f1f3f5;
            cursor: pointer;
            font-size: 14px;
            min-width: 70px;
        }

        .date-item.active {
            background: #1a7aff;
            color: #fff;
            font-weight: 600;
        }

        /* ì‹œê°„ ìŠ¬ë¡¯ */
        .slot-btn {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            width: 100%;
        }

        .slot-btn.active {
            border-color: #1a7aff;
            background: #eaf3ff;
        }

        .slot-btn.disabled {
            color: #aaa;
            background: #f5f5f5;
            pointer-events: none;
        }
    </style>
</head>

<body class="booking">
    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="header d-flex align-items-center px-3" style="height:60px;">
        <button class="btn btn-link text-white me-2" onclick="goBackStep()">
            <i class="bi bi-chevron-left fs-4"></i>
        </button>
        <h4 class="m-0 fw-bold text-white">ì„¸ì°¨ ì˜ˆì•½í•˜ê¸°</h4>
    </div>


    <div class="container mt-4">
        <!-- ì§„í–‰ë°” -->
        <div class="progress mb-4">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 20%;">Step 1 / 5</div>
        </div>

        <!-- ì˜ˆì•½ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ -->
        <div class="modal fade" id="historyModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ìµœê·¼ê¸°ë¡</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="historyList"></div>
                </div>
            </div>
        </div>

        <!-- Step 1: ì˜ˆì•½ì ì •ë³´ -->
        <div class="step active" id="step1">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">ì˜ˆì•½ì ì •ë³´</h5>
                <button type="button" class="btn btn-link btn-sm text-muted text-decoration-none" data-bs-toggle="modal"
                    data-bs-target="#historyModal">
                    ì´ì „ê¸°ë¡ì—ì„œ ì…ë ¥í•˜ê¸°
                </button>
            </div>
            <input type="text" class="form-control mb-2" id="name" placeholder="ì˜ˆì•½ì ì„±í•¨">
            <input type="tel" class="form-control mb-2" id="phone" placeholder="ì—°ë½ì²˜">
            <input type="text" class="form-control mb-2" id="address" placeholder="ì£¼ì†Œ ê²€ìƒ‰" readonly
                onclick="execDaumPostcode()">
            <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
            <script>
                function execDaumPostcode() {
                    new daum.Postcode({
                        oncomplete: function (data) {
                            // ë„ë¡œëª… ì£¼ì†Œ
                            document.getElementById("address").value = data.address;

                            // ìƒì„¸ì£¼ì†Œ ì…ë ¥ë€ ìë™ focus
                            const detailInput = document.getElementById("addressDetail");
                            detailInput.focus();

                            //íŒì—… ë‹«íˆê³  ìƒì„¸ì£¼ì†Œê¹Œì§€ ì…ë ¥í–ˆì„ ë•Œ Step2 ì´ë™
                            detailInput.addEventListener("blur", () => {
                                if (
                                    document.getElementById("name").value.trim() &&
                                    document.getElementById("phone").value.trim() &&
                                    document.getElementById("address").value.trim() &&
                                    document.getElementById("addressDetail").value.trim()
                                ) {
                                    nextStep(2);
                                }
                            }, { once: true }); // blur ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€
                        }
                    }).open();
                }

            </script>
            <input type="text" class="form-control mb-2" id="addressDetail" placeholder="ìƒì„¸ ìœ„ì¹˜ (ì˜ˆ: ì•„íŒŒíŠ¸ ë™/í˜¸)">
        </div>

        <!-- Step 2: ì°¨ëŸ‰ ì •ë³´ -->
        <div class="step" id="step2">
            <h5>ì°¨ëŸ‰ ì •ë³´</h5>
            <ul class="nav nav-tabs" id="carTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#mycar"
                        type="button">ë‚´ ì°¨ëŸ‰ì—ì„œ ì„ íƒ</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#newcar"
                        type="button">ìƒˆë¡œìš´ ì°¨ëŸ‰ ë“±ë¡</button></li>
            </ul>
            <div class="tab-content mt-3">
                <div class="tab-pane fade show active" id="mycar">
                    <div id="myCarList" class="list-group"></div>
                </div>
                <div class="tab-pane fade" id="newcar">
                    <input type="text" class="form-control mb-2" id="carNumber" placeholder="ì°¨ëŸ‰ ë²ˆí˜¸íŒ">
                    <select class="form-select mb-2" id="carCompany">
                        <option value="">ë¸Œëœë“œ ì„ íƒ</option>
                    </select>
                    <select class="form-select mb-2" id="carModel">
                        <option value="">ëª¨ë¸ ì„ íƒ</option>
                    </select>
                    <div class="alert alert-info" id="carSizeBox" style="display:none;"></div>
                </div>
            </div>
        </div>
        <!-- Step3 -->
        <div class="step" id="step3">
            <h5>ì„¸ì°¨ ì½”ìŠ¤ ì„ íƒ</h5>

            <!-- 1) ì„¸ì°¨ ì¢…ë¥˜ -->
            <div class="mb-3">
                <label class="fw-bold">ì„¸ì°¨ ì¢…ë¥˜</label><br>
                <input type="radio" name="washType" value="ì¼ë°˜ì„¸ì°¨" onchange="selectWashType('ì¼ë°˜ì„¸ì°¨')"> ì¼ë°˜ì„¸ì°¨
                <input type="radio" name="washType" value="ì •ê¸°ì„¸ì°¨" onchange="selectWashType('ì •ê¸°ì„¸ì°¨')"> ì •ê¸°ì„¸ì°¨
            </div>

            <!-- 2) êµ¬ë…ê°œì›”ìˆ˜ -->
            <div id="subscriptionBox" style="display:none;" class="mb-3">
                <label class="fw-bold">êµ¬ë… ê°œì›” ìˆ˜</label>
                <select id="subscriptionSelect" class="form-select" onchange="updateSubscription(this.value)">
                    <option value="1">1ê°œì›” (ê¸°ë³¸ê°€)</option>
                    <option value="3">3ê°œì›” (5% í• ì¸)</option>
                    <option value="6">6ê°œì›” (10% í• ì¸)</option>
                    <option value="12">12ê°œì›” (20% í• ì¸)</option>
                </select>
            </div>

            <!-- 3) ì½”ìŠ¤ ì„ íƒ -->
            <div class="mb-3">
                <label class="fw-bold">ì½”ìŠ¤ ì„ íƒ</label>
                <select id="courseSelect" class="form-select" onchange="selectCourse(this.value)">
                    <option value="">ì½”ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="basic">ë² ì´ì§ì½”ìŠ¤</option>
                    <option value="premium">í”„ë¦¬ë¯¸ì—„ì½”ìŠ¤</option>
                </select>
            </div>

            <!-- 4) ì˜µì…˜ -->
            <div class="mb-3">
                <label><input type="checkbox" id="interiorOption" onchange="toggleInterior()"> ì‹¤ë‚´ì„¸ì°¨ ì¶”ê°€</label>
            </div>

            <!-- 5) ì¿ í° -->
            <button class="btn btn-outline-primary w-100" onclick="openCouponBox()">ğŸŸ ì¿ í°/ìƒí’ˆê¶Œ ë³´ê´€í•¨</button>

            <!-- ì½”ìŠ¤ ì„¤ëª… -->
            <div id="courseDescription" class="mt-3 text-muted small"></div>

        </div>


        <!-- Step 4: ë‚ ì§œ & ì‹œê°„ -->
        <div class="step" id="step4">
            <h5>ì˜ˆì•½ ë‚ ì§œ & ì‹œê°„</h5>

            <!-- ë‚ ì§œ ì„ íƒ ë°” -->
            <div id="dateBar" class="d-flex gap-2 overflow-auto mb-3"></div>

            <!-- ì‹œê°„ ìŠ¬ë¡¯ -->
            <div id="timeSlots" class="row g-2"></div>

        </div>


        <!-- Step 5: í™•ì¸ -->
        <div class="step" id="step5">
            <h5>ì˜ˆì•½ í™•ì¸</h5>
            <div id="summary" class="border p-3 mb-3 bg-light"></div>
            <button class="btn btn-success float-end" onclick="confirmBooking()">ê²°ì œí•˜ê¸°</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="carData.js"></script>
    <script src="courseInfo.js"></script>



    <script>
        let bookingData = {
            interior: null // ì„ íƒì „ ìƒíƒœëŠ” null
        };
        let currentStep = 1;
        let calendar;
        let appliedDiscount = 0;

        //ë’¤ë¡œê°€ê¸°
        function goBackStep() {
            if (currentStep > 1) {
                document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
                document.getElementById('step' + (currentStep - 1)).classList.add('active');
                updateProgress(currentStep - 1);
            } else {
                // Step1ì¼ ë•ŒëŠ” í™ˆìœ¼ë¡œ ê°€ê±°ë‚˜ ëª¨ë‹¬ ë‹«ê¸° ë“± ì„ íƒ
                window.location.href = "index.html";
            }
        }


        // Step ì§„í–‰ë°”
        function updateProgress(step) {
            currentStep = step;
            const percent = (step / 5) * 100;
            document.getElementById("progressBar").style.width = percent + "%";
            document.getElementById("progressBar").innerText = `Step ${step} / 5`;
        }

        function nextStep(step) {
            if (step === 2) {
                const name = document.getElementById("name").value.trim();
                const phone = document.getElementById("phone").value.trim();
                const address = document.getElementById("address").value.trim();
                const addressDetail = document.getElementById("addressDetail").value.trim();

                if (!name || !phone || !address || !addressDetail) {
                    alert("ì˜ˆì•½ì ì •ë³´(ì´ë¦„, ì—°ë½ì²˜, ì£¼ì†Œ, ìƒì„¸ì£¼ì†Œ)ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
                bookingData.name = name;
                bookingData.phone = phone;
                bookingData.address = address + " " + addressDetail;
            }

            if (step === 3) {
                if (!bookingData.carNumber || !bookingData.carCompany || !bookingData.carModel || !bookingData.carSize) {
                    alert("ì°¨ëŸ‰ ì •ë³´ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                    return;
                }
            }

            if (step === 4) {
                if (!bookingData.washType) {
                    alert("ì„¸ì°¨ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (!bookingData.course || !bookingData.courseKey) {
                    alert("ì„¸ì°¨ ì½”ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (bookingData.washType === "ì •ê¸°ì„¸ì°¨" && !bookingData.months) {
                    alert("êµ¬ë… ê°œì›” ìˆ˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (bookingData.interior === null) {
                    alert("ì‹¤ë‚´ ì„¸ì°¨ ì˜µì…˜ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
            }

            if (step === 5) {
                if (!bookingData.date) {
                    alert("ì˜ˆì•½ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                if (!bookingData.time) {
                    alert("ì˜ˆì•½ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    return;
                }
                showSummary();
            }

            // âœ… ëª¨ë“  ì¡°ê±´ í†µê³¼ ì‹œ ë‹¨ê³„ ì´ë™
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            updateProgress(step);

            if (step === 4) {
                initDateBar();
            }
        }


        function checkStep3Complete() {
            if (bookingData.washType && bookingData.courseKey &&
                (bookingData.washType !== "ì •ê¸°ì„¸ì°¨" || bookingData.months)) {
                setTimeout(() => nextStep(4), 500);
            }
        }


        document.addEventListener("DOMContentLoaded", () => {
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            const editIndex = localStorage.getItem("editBookingIndex");

            if (editIndex !== null) {
                const bookingToEdit = currentUser.history[editIndex];
                if (bookingToEdit) {
                    bookingData = { ...bookingToEdit };

                    // Step1 ê¸°ë³¸ì •ë³´
                    document.getElementById("name").value = bookingToEdit.name || currentUser.name;
                    document.getElementById("phone").value = bookingToEdit.phone || currentUser.phone;
                    document.getElementById("address").value = bookingToEdit.address || currentUser.address;
                    document.getElementById("addressDetail").value = currentUser.addressDetail || "";

                    // Step2 ì°¨ëŸ‰ & Step3 ì½”ìŠ¤
                    loadMyCars();
                    initCarDropdown();
                    applyBookingDataToUI();

                    // Step4 ë‚ ì§œ/ì‹œê°„
                    setTimeout(() => {
                        initDateBar();
                        if (bookingToEdit.date && bookingToEdit.time) {
                            bookingData.date = bookingToEdit.date;
                            bookingData.time = bookingToEdit.time;
                        }
                    }, 300);

                    // í•­ìƒ Step1ì—ì„œ ì‹œì‘
                    document.querySelectorAll(".step").forEach(s => s.classList.remove("active"));
                    document.getElementById("step1").classList.add("active");
                    updateProgress(1);
                }
            } else {
                // ì‹ ê·œ ì˜ˆì•½ ë¡œì§
                if (currentUser) {
                    document.getElementById("name").value = currentUser.name || "";
                    document.getElementById("phone").value = currentUser.phone || "";
                    document.getElementById("address").value = currentUser.address || "";
                    document.getElementById("addressDetail").value = currentUser.addressDetail || "";
                }
                loadMyCars();
                initCarDropdown();
            }

            // ğŸ”‘ ì—¬ê¸°ì„œ ê³µí†µ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ í•­ìƒ ë“±ë¡ (ì‹ ê·œ/ìˆ˜ì • ë‘˜ ë‹¤)
            ["name", "phone", "address"].forEach(id => {
                document.getElementById(id).addEventListener("input", () => {
                    if (
                        document.getElementById("name").value.trim() &&
                        document.getElementById("phone").value.trim() &&
                        document.getElementById("address").value.trim()
                    ) {
                        setTimeout(() => nextStep(2), 500);
                    }
                });
            });

            document.getElementById("myCarList").addEventListener("click", (e) => {
                if (e.target.tagName === "BUTTON") {
                    setTimeout(() => nextStep(3), 500);
                }
            });

            document.querySelectorAll("input[name='washType']").forEach(r => {
                r.addEventListener("change", checkStep3Complete);
            });
            document.getElementById("courseSelect").addEventListener("change", checkStep3Complete);
            document.getElementById("subscriptionSelect").addEventListener("change", checkStep3Complete);
        });



        // ì°¨ëŸ‰ ë¦¬ìŠ¤íŠ¸
        function loadMyCars() {
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            const myCarList = document.getElementById("myCarList");
            myCarList.innerHTML = "";
            if (currentUser && currentUser.cars?.length > 0) {
                currentUser.cars.forEach((car, idx) => {
                    const btn = document.createElement("button");
                    btn.className = "list-group-item list-group-item-action";
                    btn.innerText = `${car.carNumber} - ${car.carCompany} ${car.carModel} (${car.carSize})`;
                    btn.onclick = () => {
                        bookingData.carNumber = car.carNumber;
                        bookingData.carCompany = car.carCompany;
                        bookingData.carModel = car.carModel;
                        bookingData.carSize = car.carSize;
                        document.querySelectorAll("#myCarList button").forEach(b => b.classList.remove("active"));
                        btn.classList.add("active");
                    };
                    myCarList.appendChild(btn);
                    if (idx === 0) btn.click();
                });
            } else {
                myCarList.innerHTML = `<p class="text-muted">ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
        }

        // ë¸Œëœë“œ/ëª¨ë¸ ë“œë¡­ë‹¤ìš´
        function initCarDropdown() {
            const brandSelect = document.getElementById("carCompany");
            const modelSelect = document.getElementById("carModel");
            for (let brand in carData) {
                let opt = document.createElement("option");
                opt.value = brand; opt.textContent = brand;
                brandSelect.appendChild(opt);
            }
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (currentUser && currentUser.cars?.length > 0) {
                const car = currentUser.cars[0];
                brandSelect.value = car.carCompany;
                Object.keys(carData[car.carCompany]).forEach(size => {
                    carData[car.carCompany][size].forEach(model => {
                        let opt = document.createElement("option");
                        opt.value = model; opt.textContent = model;
                        modelSelect.appendChild(opt);
                    });
                });
                modelSelect.value = car.carModel;
                bookingData.carNumber = car.carNumber;
                bookingData.carCompany = car.carCompany;
                bookingData.carModel = car.carModel;
                bookingData.carSize = car.carSize;
            }
            brandSelect.addEventListener("change", () => {
                modelSelect.innerHTML = "<option value=''>ëª¨ë¸ ì„ íƒ</option>";
                if (brandSelect.value) {
                    Object.keys(carData[brandSelect.value]).forEach(size => {
                        carData[brandSelect.value][size].forEach(model => {
                            let opt = document.createElement("option");
                            opt.value = model; opt.textContent = model;
                            modelSelect.appendChild(opt);
                        });
                    });
                }
            });
            modelSelect.addEventListener("change", () => {
                const brand = brandSelect.value;
                const model = modelSelect.value;
                let detectedSize = "";
                Object.keys(carData[brand]).forEach(size => {
                    if (carData[brand][size].includes(model)) detectedSize = size;
                });
                bookingData.carCompany = brand;
                bookingData.carModel = model;
                bookingData.carSize = detectedSize;
                bookingData.carNumber = document.getElementById("carNumber").value;
                const box = document.getElementById("carSizeBox");
                box.style.display = "block";
                box.innerText = `ìë™ ë¶„ë¥˜ëœ ì°¨ëŸ‰ í¬ê¸°: ${bookingData.carSize}`;
            });
        }

        // ê°€ê²©í‘œ + ì„ íƒ ë³µì›
        const priceTable = {
            "ê²½í˜•": { one: 25000, month4: 35000, month8: 55000, interior: 10000 },
            "ì¤€ì¤‘í˜•": { one: 30000, month4: 40000, month8: 65000, interior: 10000 },
            "ì¤€ëŒ€í˜•": { one: 35000, month4: 45000, month8: 75000, interior: 10000 },
            "ëŒ€í˜•": { one: 40000, month4: 50000, month8: 80000, interior: 10000 },
            "SUV": { one: 40000, month4: 50000, month8: 85000, interior: 10000 },
            "RV": { one: 45000, month4: 55000, month8: 90000, interior: 10000 }
        };


        function selectWashType(type) {
            bookingData.washType = type;
            if (type === "ì •ê¸°ì„¸ì°¨") {
                document.getElementById("subscriptionBox").style.display = "block";
                bookingData.months = 1; // ê¸°ë³¸ 1ê°œì›”
            } else {
                document.getElementById("subscriptionBox").style.display = "none";
                bookingData.months = null;
            }
            updateSummaryBar();
        }

        function updateSubscription(months) {
            bookingData.months = parseInt(months);
            updateSummaryBar();
        }

        function selectCourse(value) {
            bookingData.courseKey = value || null;

            if (value === "basic") {
                bookingData.course = courseInfo.basic.title;
                bookingData.courseDesc = courseInfo.basic.tagline;
            } else if (value === "premium") {
                bookingData.course = courseInfo.premium.title;
                bookingData.courseDesc = courseInfo.premium.tagline;
            } else {
                bookingData.course = "";
                bookingData.courseDesc = "";
            }
            updateSummaryBar(); // ì„ íƒ ì¦‰ì‹œ ì¹´ë“œ ê°±ì‹  & ê¸ˆì•¡ ê°±ì‹ 
        }


        function toggleInterior() {
            // ì²´í¬í•˜ë©´ true, í•´ì œí•˜ë©´ false
            bookingData.interior = document.getElementById("interiorOption").checked;
            checkStep3Complete(); // âœ… ì˜µì…˜ ì„ íƒ ì‹œì—ë„ ê²€ì‚¬ ì‹¤í–‰
            updateSummaryBar();
        }

        function checkStep3Complete() {
            if (
                bookingData.washType &&
                bookingData.courseKey &&
                (bookingData.washType !== "ì •ê¸°ì„¸ì°¨" || bookingData.months) &&
                bookingData.interior !== null // âœ… ì‹¤ë‚´ì„¸ì°¨ ì„ íƒ ì—¬ë¶€ ë°˜ë“œì‹œ ë°˜ì˜
            ) {
                setTimeout(() => nextStep(4), 500);
            }
        }


        function openCouponBox() {
            const myCoupons = [
                { code: "WELCOME10", discount: 0.1, text: "ì²« êµ¬ë§¤ 10%" },
                { code: "EVENT20", discount: 0.2, text: "ì´ë²¤íŠ¸ 20%" }
            ];
            const best = myCoupons.reduce((a, b) => a.discount > b.discount ? a : b);
            bookingData.discountText = best.text;
            appliedDiscount = best.discount;
            alert(`${best.text} ì¿ í°ì´ ìë™ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            updateSummaryBar();
        }
        //ì˜ˆì•½ëœ ì½”ìŠ¤ ì„¤ëª…
        function updateSummaryBar() {
            // ê¸ˆì•¡ ê³„ì‚°
            let total = 0;
            if (bookingData.carSize) {
                let base = priceTable[bookingData.carSize]?.one || 30000;
                total = base;

                if (bookingData.washType === "ì •ê¸°ì„¸ì°¨" && bookingData.months) {
                    if (bookingData.months == 3) total = base * 3 * 0.95;
                    if (bookingData.months == 6) total = base * 6 * 0.9;
                    if (bookingData.months == 12) total = base * 12 * 0.8;
                    if (bookingData.months == 1) total = base;
                }

                // âœ… carSizeê°€ priceTableì— ì—†ì„ ë•Œ ë°©ì–´
                if (bookingData.interior && priceTable[bookingData.carSize]) {
                    total += priceTable[bookingData.carSize].interior;
                }

                if (appliedDiscount > 0) total *= (1 - appliedDiscount);
            }

            bookingData.finalPrice = total;

            // ì½”ìŠ¤ ìƒì„¸ ì¹´ë“œ ê°±ì‹ 
            renderCourseCard();
        }


        function renderCourseCard() {
            const key = bookingData.courseKey;
            const info = key ? courseInfo[key] : null;

            // ì„ íƒ ì•ˆ í–ˆìœ¼ë©´ ì¹´ë“œ ìˆ¨ê¹€
            if (!bookingData.washType && !bookingData.course && !bookingData.interior) {
                document.getElementById("courseDescription").innerHTML = "";
                return;
            }

            const size = bookingData.carSize;
            const time = info && size ? (info.timeBySize[size] || "") : "";
            const monthsText = bookingData.washType === "ì •ê¸°ì„¸ì°¨" && bookingData.months
                ? bookingData.months + "ê°œì›”"
                : "";
            const optionText = bookingData.interior ? "ì‹¤ë‚´ì„¸ì°¨ í¬í•¨" : "";
            const discountText = bookingData.discountText || "";

            const includesHtml = info && info.includes.length
                ? info.includes.map(i => `<li>${i}</li>`).join("")
                : "";
            const notHtml = info && info.not_included.length
                ? info.not_included.map(i => `<li>${i}</li>`).join("")
                : "";
            const recommend = info ? info.recommend : "";

            // ì¹´ë“œ UI
            let html = `
      <div class="card shadow-sm border-0">
        <div class="card-body p-3">
          ${bookingData.course ? `<h6 class="card-title mb-1">${bookingData.course}</h6>` : ""}
          ${bookingData.courseDesc ? `<p class="card-subtitle text-muted small mb-2">${bookingData.courseDesc}</p>` : ""}
          ${recommend ? `<div class="small mb-2"><i class="bi bi-stars"></i> ${recommend}</div>` : ""}

          <div class="row g-2 small">
    `;

            if (includesHtml) {
                html += `
        <div class="col-12 col-md-6">
          <div class="border rounded p-2 h-100">
            <div class="fw-semibold mb-1">í¬í•¨ í•­ëª©</div>
            <ul class="mb-0 ps-3">${includesHtml}</ul>
          </div>
        </div>`;
            }

            if (notHtml) {
                html += `
        <div class="col-12 col-md-6">
          <div class="border rounded p-2 h-100">
            <div class="fw-semibold mb-1">ë¯¸í¬í•¨</div>
            <ul class="mb-0 ps-3">${notHtml}</ul>
          </div>
        </div>`;
            }

            html += `</div><hr class="my-2"><div class="d-flex flex-wrap gap-3 small">`;

            if (size) html += `<div><b>ì°¨ëŸ‰ í¬ê¸°:</b> ${size}</div>`;
            if (time) html += `<div><b>ì˜ˆìƒ ì†Œìš”:</b> ${time}</div>`;
            if (bookingData.washType) html += `<div><b>ì„¸ì°¨ì¢…ë¥˜:</b> ${bookingData.washType}</div>`;
            if (monthsText) html += `<div><b>êµ¬ë…ê°œì›”:</b> ${monthsText}</div>`;
            if (optionText) html += `<div><b>ì˜µì…˜:</b> ${optionText}</div>`;
            if (discountText) html += `<div><b>í• ì¸:</b> ${discountText}</div>`;

            html += `
          </div>
          ${bookingData.finalPrice ? `<div class="mt-2 fw-bold text-primary">ìµœì¢… ê¸ˆì•¡: ${bookingData.finalPrice.toLocaleString()}ì›</div>` : ""}
          <div class="text-muted small mt-1">â€» ì˜¤ì—¼ë„/ê¸°ìƒ/ì°¨ëŸ‰ ìƒíƒœì— ë”°ë¼ ì‘ì—… ì‹œê°„ê³¼ ê¸ˆì•¡ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
    `;

            document.getElementById("courseDescription").innerHTML = html;
        }

        // bookingData â†’ Step3 UI ë°˜ì˜ í•¨ìˆ˜
        function applyBookingDataToUI() {
            // ì„¸ì°¨ ì¢…ë¥˜ (radio)
            if (bookingData.washType) {
                document.querySelectorAll("input[name='washType']").forEach(radio => {
                    radio.checked = (radio.value === bookingData.washType);
                });
                selectWashType(bookingData.washType); // êµ¬ë…ë°•ìŠ¤ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° ì²˜ë¦¬
            }

            // êµ¬ë… ê°œì›” (select)
            if (bookingData.months) {
                document.getElementById("subscriptionSelect").value = bookingData.months;
            }

            // ì½”ìŠ¤ (select)
            if (bookingData.courseKey) {
                document.getElementById("courseSelect").value = bookingData.courseKey;
                selectCourse(bookingData.courseKey); // ì½”ìŠ¤ ì¹´ë“œ ì—…ë°ì´íŠ¸
            }

            // ì‹¤ë‚´ ì˜µì…˜ (checkbox)
            document.getElementById("interiorOption").checked = !!bookingData.interior;

            // ìµœì¢… ì¹´ë“œ ê°±ì‹ 
            updateSummaryBar();
        }

        let dateOffset = 0; // ì˜¤ëŠ˜ë¶€í„° ë©°ì¹ ì„ ìƒì„±í–ˆëŠ”ì§€ ê¸°ë¡

        // Step4: ë‚ ì§œ ë°” ì´ˆê¸°í™”
        function initDateBar() {
            const dateBar = document.getElementById("dateBar");
            dateBar.innerHTML = "";
            dateOffset = 0;
            appendDates(7); // ìµœì´ˆ 7ì¼ ìƒì„±

            // ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸: ëê¹Œì§€ ê°€ë©´ ì¶”ê°€ ë‚ ì§œ ë¶™ì´ê¸°
            dateBar.onscroll = () => {
                if (dateBar.scrollLeft + dateBar.clientWidth >= dateBar.scrollWidth - 10) {
                    appendDates(7);
                }
            };
        }

        // Step4: ë‚ ì§œ ì¶”ê°€ í•¨ìˆ˜
        function appendDates(count = 7) {
            const dateBar = document.getElementById("dateBar");
            const today = new Date();

            for (let i = 0; i < count; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + dateOffset + i);

                const dayStr = d.toLocaleDateString("ko-KR", { month: "numeric", day: "numeric" });
                const weekStr = d.toLocaleDateString("ko-KR", { weekday: "short" });

                const div = document.createElement("div");
                div.className = "date-item";
                div.innerHTML = `${dayStr}<br><small>${(dateOffset + i) === 0 ? "ì˜¤ëŠ˜" : weekStr}</small>`;
                div.onclick = () => {
                    bookingData.date = d.toISOString().split("T")[0];
                    document.querySelectorAll(".date-item").forEach(el => el.classList.remove("active"));
                    div.classList.add("active");
                    renderTimeSlots(d);
                };

                // ì²« ë²ˆì§¸(ì˜¤ëŠ˜) ìë™ ì„ íƒ
                if (dateOffset === 0 && i === 0) {
                    div.classList.add("active");
                    bookingData.date = d.toISOString().split("T")[0];
                    renderTimeSlots(d);
                }

                dateBar.appendChild(div);
            }

            dateOffset += count; // ì˜¤í”„ì…‹ ê°±ì‹ 
        }

        // Step4: ì‹œê°„ ìŠ¬ë¡¯ ìƒì„±
        // Step4: ì‹œê°„ ìŠ¬ë¡¯ ìƒì„±
        function renderTimeSlots(date) {
            const container = document.getElementById("timeSlots");
            container.innerHTML = "";

            for (let h = 10; h <= 24; h++) {
                const timeStr = (h < 10 ? "0" : "") + h + ":00";

                const col = document.createElement("div");
                col.className = "col-6 col-md-3";

                const btn = document.createElement("button");
                btn.className = "slot-btn";
                btn.innerHTML = `${timeStr}<br><small>ì”ì—¬ 1/1</small>`;
                btn.onclick = () => {
                    bookingData.time = timeStr;
                    document.querySelectorAll(".slot-btn").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");

                    // âœ… ë‚ ì§œ & ì‹œê°„ê¹Œì§€ ëª¨ë‘ ì„ íƒë˜ë©´ Step5ë¡œ ìë™ ì´ë™
                    if (bookingData.date && bookingData.time) {
                        setTimeout(() => nextStep(5), 500);
                    }
                };

                col.appendChild(btn);
                container.appendChild(col);
            }
        }


        //ì˜ˆì•½í™•ì¸
        function showSummary() {
            const summaryDiv = document.getElementById("summary");
            summaryDiv.innerHTML = `
        <p><b>ì˜ˆì•½ì:</b> ${bookingData.name}</p>
        <p><b>ì—°ë½ì²˜:</b> ${bookingData.phone}</p>
        <p><b>ì£¼ì†Œ:</b> ${bookingData.address}</p>
        <p><b>ì°¨ëŸ‰:</b> ${bookingData.carNumber} - ${bookingData.carCompany} ${bookingData.carModel} (${bookingData.carSize})</p>
        <p><b>ì„¸ì°¨ì¢…ë¥˜:</b> ${bookingData.washType}</p>
        <p><b>ì½”ìŠ¤:</b> ${bookingData.course}</p>
        <p><b>ì˜µì…˜:</b> ${bookingData.interior ? "ì‹¤ë‚´ì„¸ì°¨" : "ì—†ìŒ"}</p>
        <p><b>ë‚ ì§œ/ì‹œê°„:</b> ${bookingData.date} ${bookingData.time}</p>
        <p><b>ìµœì¢…ê¸ˆì•¡:</b> <span class="fw-bold text-primary">${bookingData.finalPrice.toLocaleString()}ì›</span></p>
    `;
        }

        function confirmBooking() {
            const newBooking = {
                name: bookingData.name,
                phone: bookingData.phone,
                address: bookingData.address,
                addressDetail: document.getElementById("addressDetail").value,
                carNumber: bookingData.carNumber,
                carCompany: bookingData.carCompany,
                carModel: bookingData.carModel,
                carSize: bookingData.carSize,
                washType: bookingData.washType,
                months: bookingData.months,
                course: bookingData.course,
                courseKey: bookingData.courseKey,
                courseDesc: bookingData.courseDesc,
                interior: bookingData.interior,
                finalPrice: bookingData.finalPrice,
                dateStr: bookingData.date,
                time: bookingData.time,
                status: "ì˜ˆì•½ëŒ€ê¸°"
            };

            let currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (!currentUser) {
                currentUser = {
                    name: bookingData.name,
                    phone: bookingData.phone,
                    address: bookingData.address,
                    addressDetail: bookingData.addressDetail,
                    cars: [],
                    history: [],
                    coupons: []
                };
            }
            if (!currentUser.history) currentUser.history = [];

            const editIndex = localStorage.getItem("editBookingIndex");

            if (editIndex !== null) {
                const idx = parseInt(editIndex, 10);
                currentUser.history[idx] = {
                    ...currentUser.history[idx],
                    ...newBooking
                };
                localStorage.removeItem("editBookingIndex");
            } else {
                currentUser.history.push(newBooking);
            }

            currentUser.name = bookingData.name;
            currentUser.phone = bookingData.phone;
            currentUser.address = bookingData.address;
            currentUser.addressDetail = bookingData.addressDetail;

            localStorage.setItem("currentUser", JSON.stringify(currentUser));

            alert(editIndex !== null ? "ì˜ˆì•½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!" : "ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            window.location.href = "usage.html";
        }

        function openCouponBox() {
            let currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (!currentUser || !currentUser.coupons || currentUser.coupons.length === 0) {
                alert("ì‚¬ìš© ê°€ëŠ¥í•œ ì¿ í°ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }
            const best = currentUser.coupons.reduce((a, b) => a.discount > b.discount ? a : b);
            bookingData.discountText = best.text;
            appliedDiscount = best.discount;
            alert(`${best.text} ì¿ í°ì´ ìë™ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            updateSummaryBar();
        }


        // íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ì±„ìš°ê¸°
        document.getElementById("historyModal").addEventListener("show.bs.modal", () => {
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            const listDiv = document.getElementById("historyList");
            listDiv.innerHTML = "";
            if (!currentUser || !currentUser.history || currentUser.history.length === 0) {
                listDiv.innerHTML = "<p class='text-muted'>ì˜ˆì•½ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            currentUser.history.forEach((h) => {
                const card = document.createElement("div");
                card.className = "card mb-3 shadow-sm";
                card.style.cursor = "pointer";
                card.innerHTML = `
    <div class="card-body p-3">
        <div class="d-flex justify-content-between">
            <h6 class="card-title mb-1">${h.course || "ì½”ìŠ¤ ë¯¸ì§€ì •"}</h6>
            <small class="text-muted">${h.date}</small>
        </div>
        <p class="card-subtitle text-muted small mb-2">
            ${h.carNumber} - ${h.carCompany} ${h.carModel} (${h.carSize})
        </p>
        <p class="mb-1"><b>ë‚ ì§œ/ì‹œê°„:</b> ${h.dateStr} ${h.time}</p>
        <p class="mb-0"><b>ê²°ì œê¸ˆì•¡:</b> ${h.finalPrice?.toLocaleString() || 0}ì›</p>
    </div>
    `;
                card.onclick = () => {
                    document.getElementById("name").value = currentUser.name || "";
                    document.getElementById("phone").value = currentUser.phone || "";
                    document.getElementById("address").value = currentUser.address || "";
                    document.getElementById("addressDetail").value = currentUser.addressDetail || "";

                    bookingData = {
                        ...bookingData, ...h,
                        name: currentUser.name,
                        phone: currentUser.phone,
                        address: currentUser.address
                    };

                    // UIì™€ ë™ê¸°í™”
                    applyBookingDataToUI();

                    const now = new Date();
                    const selectedDate = new Date(`${h.dateStr} ${h.time}`);
                    if (!(selectedDate > now)) {
                        bookingData.date = "";
                        bookingData.time = "";
                        alert("ê³¼ê±° ì˜ˆì•½ì´ë¯€ë¡œ ë‚ ì§œ/ì‹œê°„ì€ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    }
                    bootstrap.Modal.getInstance(document.getElementById("historyModal")).hide();
                    nextStep(4);
                    return;
                };

                listDiv.appendChild(card);
            });
        });

    </script>
</body>

</html>