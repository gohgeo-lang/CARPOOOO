<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARPOOOO - ì„¸ì°¨ ì˜ˆì•½í•˜ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <style>
        .step {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        .step.active {
            display: block;
            opacity: 1;
        }

        #calendar {
            min-height: 500px;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="header">
        <h4 class="fw-bold">ì„¸ì°¨ ì˜ˆì•½í•˜ê¸°</h4>
        <p class="mb-0">ì›í•˜ëŠ” ì½”ìŠ¤ì™€ ë‚ ì§œ/ì‹œê°„ì„ ì„ íƒí•˜ì„¸ìš”</p>
    </div>

    <div class="container mt-4">
        <!-- ì§„í–‰ë°” -->
        <div class="progress mb-4">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 20%;">
                Step 1 / 5
            </div>
        </div>

        <!-- Step 1: ì˜ˆì•½ì ì •ë³´ -->
        <div class="step active" id="step1">
            <h5>ğŸ‘¤ ì˜ˆì•½ì ì •ë³´</h5>
            <input type="text" class="form-control mb-2" id="name" placeholder="ì˜ˆì•½ì ì„±í•¨">
            <input type="tel" class="form-control mb-2" id="phone" placeholder="ì—°ë½ì²˜">
            <input type="text" class="form-control mb-2" id="address" placeholder="ì£¼ì†Œ ê²€ìƒ‰" readonly
                onclick="execDaumPostcode()">
            <input type="text" class="form-control mb-2" id="addressDetail" placeholder="ìƒì„¸ ìœ„ì¹˜ (ì˜ˆ: ì•„íŒŒíŠ¸ ë™/í˜¸)">
            <button class="btn btn-primary w-100 mt-3" onclick="nextStep(2)">ë‹¤ìŒ</button>
        </div>

        <!-- Step 2: ì°¨ëŸ‰ ì •ë³´ -->
        <div class="step" id="step2">
            <h5>ğŸš— ì°¨ëŸ‰ ì •ë³´</h5>
            <!-- íƒ­ ë²„íŠ¼ -->
            <ul class="nav nav-tabs" id="carTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="mycar-tab" data-bs-toggle="tab" data-bs-target="#mycar"
                        type="button" role="tab">
                        ë‚´ ì°¨ëŸ‰ì—ì„œ ì„ íƒ
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="newcar-tab" data-bs-toggle="tab" data-bs-target="#newcar" type="button"
                        role="tab">
                        ìƒˆë¡œìš´ ì°¨ëŸ‰ ë“±ë¡
                    </button>
                </li>
            </ul>

            <div class="tab-content mt-3">
                <!-- ë‚´ ì°¨ëŸ‰ ì„ íƒ -->
                <div class="tab-pane fade show active" id="mycar" role="tabpanel">
                    <div id="myCarList" class="list-group"></div>
                </div>
                <!-- ìƒˆ ì°¨ëŸ‰ ë“±ë¡ -->
                <div class="tab-pane fade" id="newcar" role="tabpanel">
                    <input type="text" class="form-control mb-2" id="carNumber" placeholder="ì°¨ëŸ‰ ë²ˆí˜¸íŒ">
                    <select class="form-select mb-2" id="carCompany">
                        <option value="">ì œì¡°ì‚¬ ì„ íƒ</option>
                        <option value="í˜„ëŒ€">í˜„ëŒ€</option>
                        <option value="ê¸°ì•„">ê¸°ì•„</option>
                    </select>
                    <select class="form-select mb-2" id="carModel">
                        <option value="">ëª¨ë¸ ì„ íƒ</option>
                    </select>
                    <div class="alert alert-info" id="carSizeBox" style="display:none;"></div>
                </div>
            </div>
            <button class="btn btn-secondary mt-3" onclick="prevStep(1)">ì´ì „</button>
            <button class="btn btn-primary mt-3 float-end" onclick="nextStep(3)">ë‹¤ìŒ</button>
        </div>

        <!-- Step 3: ì„¸ì°¨ ì½”ìŠ¤ -->
        <div class="step" id="step3">
            <h5>ğŸ§½ ì„¸ì°¨ ì½”ìŠ¤ ì„ íƒ</h5>
            <p class="text-muted">ì°¨ëŸ‰ í¬ê¸°ì— ë”°ë¼ ê°€ê²©ì´ ìë™ ì ìš©ë©ë‹ˆë‹¤.</p>
            <div id="priceTable"></div>

            <!-- ì•„ì½”ë””ì–¸: ì„ íƒë‚´ì—­ -->
            <div class="accordion mt-4" id="courseAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingSummary">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                            data-bs-target="#collapseSummary">
                            ì„ íƒí•œ ì½”ìŠ¤ / ì˜µì…˜ ìš”ì•½
                        </button>
                    </h2>
                    <div id="collapseSummary" class="accordion-collapse collapse">
                        <div class="accordion-body">
                            <div id="selectedCourse"></div>
                            <div class="input-group mt-3">
                                <input type="text" id="couponCode" class="form-control" placeholder="ì¿ í° ì½”ë“œ ì…ë ¥">
                                <button class="btn btn-outline-primary" onclick="applyCoupon()">ì ìš©</button>
                            </div>
                            <div id="discountInfo" class="text-success mt-2"></div>
                            <div class="fw-bold mt-2" id="totalPrice"></div>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn btn-secondary mt-3" onclick="prevStep(2)">ì´ì „</button>
            <button class="btn btn-primary mt-3 float-end" onclick="nextStep(4)">ë‹¤ìŒ</button>
        </div>

        <!-- Step 4: ë‚ ì§œ & ì‹œê°„ -->
        <div class="step" id="step4">
            <h5>ğŸ“… ì˜ˆì•½ ë‚ ì§œ & ì‹œê°„</h5>
            <div id="calendar"></div>
            <div id="timeSlots" class="mt-3"></div>
            <button class="btn btn-secondary mt-3" onclick="prevStep(3)">ì´ì „</button>
            <button class="btn btn-primary mt-3 float-end" onclick="nextStep(5)">ë‹¤ìŒ</button>
        </div>

        <!-- Step 5: í™•ì¸ -->
        <div class="step" id="step5">
            <h5>âœ… ì˜ˆì•½ í™•ì¸</h5>
            <div id="summary" class="border p-3 mb-3 bg-light"></div>
            <button class="btn btn-secondary" onclick="prevStep(4)">ì´ì „</button>
            <button class="btn btn-success float-end" onclick="confirmBooking()">ê²°ì œí•˜ê¸°</button>
        </div>
    </div>

    <!-- í•˜ë‹¨ íƒ­ë°” -->
    <div class="tabbar">
        <div onclick="location.href='search.html'"><i class="bi bi-search"></i>ê²€ìƒ‰</div>
        <div class="active"><i class="bi bi-calendar-check"></i>ì˜ˆì•½</div>
        <div onclick="location.href='index.html'"><i class="bi bi-house-door-fill"></i>í™ˆ</div>
        <div onclick="location.href='wishlist.html'"><i class="bi bi-heart-fill"></i>ì°œ</div>
        <div onclick="location.href='mypage.html'"><i class="bi bi-person-circle"></i>ë§ˆì´</div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        let bookingData = {};
        let currentStep = 1;
        let calendar;
        let appliedDiscount = 0;

        // ì°¨ëŸ‰ DB
        const carDatabase = {
            "í˜„ëŒ€": { "ëª¨ë‹": "ê²½í˜•", "ì•„ë°˜ë–¼": "ì¤€ì¤‘í˜•", "ì†Œë‚˜íƒ€": "ì¤€ëŒ€í˜•", "ê·¸ëœì €": "ëŒ€í˜•" },
            "ê¸°ì•„": { "ë ˆì´": "ê²½í˜•", "K3": "ì¤€ì¤‘í˜•", "K5": "ì¤€ëŒ€í˜•", "ì¹´ë‹ˆë°œ": "RV" }
        };

        // ì°¨ëŸ‰ë³„ ê°€ê²©í‘œ
        const priceTable = {
            "ê²½í˜•": { one: 25000, month4: 35000, month8: 55000, interior: 10000 },
            "ì¤€ì¤‘í˜•": { one: 30000, month4: 40000, month8: 65000, interior: 10000 },
            "ì¤€ëŒ€í˜•": { one: 35000, month4: 45000, month8: 75000, interior: 10000 },
            "ëŒ€í˜•": { one: 40000, month4: 50000, month8: 80000, interior: 10000 },
            "SUV": { one: 40000, month4: 50000, month8: 85000, interior: 10000 },
            "RV": { one: 45000, month4: 55000, month8: 90000, interior: 10000 }
        };

        // Step ì´ë™
        function updateProgress(step) {
            currentStep = step;
            const percent = (step / 5) * 100;
            document.getElementById("progressBar").style.width = percent + "%";
            document.getElementById("progressBar").innerText = `Step ${step} / 5`;
        }

        function nextStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            updateProgress(step);

            if (step === 3) renderPriceTable();
            if (step === 4 && calendar) setTimeout(() => calendar.render(), 200);
            if (step === 5) {
                bookingData.name = document.getElementById('name').value;
                bookingData.phone = document.getElementById('phone').value;
                bookingData.address = document.getElementById('address').value + " " + document.getElementById('addressDetail').value;
                bookingData.carNumber = document.getElementById('carNumber').value;

                document.getElementById("summary").innerHTML = `
          <p><b>ì´ë¦„:</b> ${bookingData.name}</p>
          <p><b>ì—°ë½ì²˜:</b> ${bookingData.phone}</p>
          <p><b>ì°¨ëŸ‰ë²ˆí˜¸:</b> ${bookingData.carNumber}</p>
          <p><b>ì°¨ì¢…:</b> ${bookingData.carCompany} ${bookingData.carModel} (${bookingData.carSize})</p>
          <p><b>ì£¼ì†Œ:</b> ${bookingData.address}</p>
          <p><b>ì½”ìŠ¤:</b> ${bookingData.course}</p>
          <p><b>êµ¬ë…ê°œì›”ìˆ˜:</b> ${bookingData.months || 'í•´ë‹¹ì—†ìŒ'}</p>
          <p><b>ì˜µì…˜:</b> ${bookingData.options ? bookingData.options.join(', ') : 'ì—†ìŒ'}</p>
          <p><b>í• ì¸:</b> ${bookingData.discountText || 'ì—†ìŒ'}</p>
          <p class="fw-bold"><b>ìµœì¢… ê²°ì œê¸ˆì•¡:</b> ${bookingData.finalPrice ? bookingData.finalPrice.toLocaleString() : 0}ì›</p>
          <p><b>ì˜ˆì•½ì¼:</b> ${bookingData.date || ''} ${bookingData.time || ''}</p>
        `;
            }
        }
        function prevStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            updateProgress(step);
        }

        // Step1 ìë™ ì…ë ¥ (ë¡œê·¸ì¸ ì‹œ)
        function loadUserInfo() {
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (currentUser) {
                document.getElementById("name").value = currentUser.name || "";
                document.getElementById("phone").value = currentUser.phone || "";
                document.getElementById("address").value = currentUser.address || "";
                document.getElementById("addressDetail").value = currentUser.addressDetail || "";
            }
        }
        document.addEventListener("DOMContentLoaded", loadUserInfo);

        // ë‚´ ì°¨ëŸ‰ ë¶ˆëŸ¬ì˜¤ê¸°
        function loadMyCars() {
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            const myCarList = document.getElementById("myCarList");
            myCarList.innerHTML = "";

            if (currentUser && currentUser.cars && currentUser.cars.length > 0) {
                currentUser.cars.forEach((car, idx) => {
                    const btn = document.createElement("button");
                    btn.className = "list-group-item list-group-item-action";
                    btn.innerText = `${car.carNumber} - ${car.carCompany} ${car.carModel} (${car.carSize})`;
                    btn.onclick = () => {
                        bookingData.carNumber = car.carNumber;
                        bookingData.carCompany = car.carCompany;
                        bookingData.carModel = car.carModel;
                        bookingData.carSize = car.carSize;
                        document.querySelectorAll("#myCarList button").forEach(b => b.classList.remove("active"));
                        btn.classList.add("active");
                    };
                    myCarList.appendChild(btn);
                });
            } else {
                myCarList.innerHTML = `<p class="text-muted">ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤. "ìƒˆë¡œìš´ ì°¨ëŸ‰ ë“±ë¡" íƒ­ì—ì„œ ì¶”ê°€í•˜ì„¸ìš”.</p>`;
            }
        }
        document.addEventListener("DOMContentLoaded", loadMyCars);

        // ì£¼ì†Œ ê²€ìƒ‰ (ì¹´ì¹´ì˜¤)
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function (data) {
                    document.getElementById("address").value = data.address;
                }
            }).open();
        }

        // ì œì¡°ì‚¬ ì„ íƒ ì‹œ ëª¨ë¸ ì—…ë°ì´íŠ¸
        document.getElementById("carCompany").addEventListener("change", function () {
            const company = this.value;
            const modelSelect = document.getElementById("carModel");
            modelSelect.innerHTML = "<option value=''>ëª¨ë¸ ì„ íƒ</option>";
            if (carDatabase[company]) {
                Object.keys(carDatabase[company]).forEach(model => {
                    const opt = document.createElement("option");
                    opt.value = model;
                    opt.innerText = model;
                    modelSelect.appendChild(opt);
                });
            }
        });

        // ëª¨ë¸ ì„ íƒ ì‹œ í¬ê¸° ë§¤í•‘
        document.getElementById("carModel").addEventListener("change", function () {
            const company = document.getElementById("carCompany").value;
            const model = this.value;
            if (carDatabase[company] && carDatabase[company][model]) {
                bookingData.carCompany = company;
                bookingData.carModel = model;
                bookingData.carSize = carDatabase[company][model];
                const box = document.getElementById("carSizeBox");
                box.style.display = "block";
                box.innerText = `ìë™ ë¶„ë¥˜ëœ ì°¨ëŸ‰ í¬ê¸°: ${bookingData.carSize}`;
            }
        });

        // Step3 ê°€ê²©í‘œ & ë¡œì§
        function renderPriceTable() {
            const size = bookingData.carSize;
            if (!size) return;
            const p = priceTable[size];
            const div = document.getElementById("priceTable");
            div.innerHTML = `
        <table class="table text-center align-middle">
          <thead class="table-dark"><tr><th>ì½”ìŠ¤</th><th>ì„ íƒ</th></tr></thead>
          <tbody>
            <tr>
              <td>ì¼ë°˜ì„¸ì°¨ (1íšŒ)</td>
              <td><button class="btn btn-outline-primary" onclick="selectCourse('ì¼ë°˜ì„¸ì°¨', ${p.one}, false)">ì„ íƒ (${p.one}ì›)</button></td>
            </tr>
            <tr>
              <td>ì •ê¸°ì„¸ì°¨</td>
              <td>
                <select class="form-select" onchange="selectCourse('ì •ê¸°ì„¸ì°¨', ${p.month4}, true, this.value)">
                  <option value="">ê°œì›” ì„ íƒ</option>
                  <option value="1">1ê°œì›” (${p.month4}ì›)</option>
                  <option value="6">6ê°œì›” (10% í• ì¸)</option>
                  <option value="12">12ê°œì›” (20% í• ì¸)</option>
                </select>
              </td>
            </tr>
            <tr>
              <td>ë‚´ë¶€ì„¸ì°¨ ì¶”ê°€</td>
              <td><button class="btn btn-outline-secondary" onclick="toggleOption('ë‚´ë¶€ì„¸ì°¨ ì¶”ê°€', ${p.interior})">+${p.interior}ì›</button></td>
            </tr>
          </tbody>
        </table>
      `;
            updateSummary();
        }

        function selectCourse(name, basePrice, isSub, months) {
            bookingData.course = name;
            bookingData.basePrice = basePrice;
            if (isSub && months) {
                bookingData.months = parseInt(months);
                let discount = 0;
                if (months == 6) discount = 0.1;
                if (months == 12) discount = 0.2;
                bookingData.basePrice = basePrice * months * (1 - discount);
            } else {
                bookingData.months = null;
            }
            updateSummary();
        }

        function toggleOption(name, price) {
            if (!bookingData.options) bookingData.options = [];
            if (!bookingData.optionPrice) bookingData.optionPrice = 0;

            if (bookingData.options.includes(name)) {
                bookingData.options = bookingData.options.filter(o => o !== name);
                bookingData.optionPrice -= price;
            } else {
                bookingData.options.push(name);
                bookingData.optionPrice += price;
            }
            updateSummary();
        }

        function applyCoupon() {
            const code = document.getElementById("couponCode").value.trim().toUpperCase();
            appliedDiscount = 0;
            bookingData.discountText = "";

            if (code === "WELCOME10") {
                appliedDiscount = 0.1;
                bookingData.discountText = "WELCOME10 (10% í• ì¸)";
            } else if (code === "EVENT20") {
                appliedDiscount = 0.2;
                bookingData.discountText = "EVENT20 (20% í• ì¸)";
            } else {
                document.getElementById("discountInfo").innerText = "ìœ íš¨í•˜ì§€ ì•Šì€ ì¿ í° ì½”ë“œì…ë‹ˆë‹¤.";
                updateSummary();
                return;
            }
            document.getElementById("discountInfo").innerText = bookingData.discountText;
            updateSummary();
        }

        function updateSummary() {
            let total = (bookingData.basePrice || 0) + (bookingData.optionPrice || 0);
            if (appliedDiscount > 0) {
                total = total * (1 - appliedDiscount);
            }
            bookingData.finalPrice = total;
            document.getElementById("selectedCourse").innerHTML = `
        <p><b>ì½”ìŠ¤:</b> ${bookingData.course || 'ë¯¸ì„ íƒ'}</p>
        <p><b>êµ¬ë…ê°œì›”ìˆ˜:</b> ${bookingData.months || 'í•´ë‹¹ì—†ìŒ'}</p>
        <p><b>ì˜µì…˜:</b> ${bookingData.options ? bookingData.options.join(', ') : 'ì—†ìŒ'}</p>
      `;
            document.getElementById("totalPrice").innerText = "ì´ ê²°ì œê¸ˆì•¡: " + total.toLocaleString() + "ì›";
        }

        // FullCalendar
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                height: 500,
                dateClick: function (info) {
                    showTimeSlots(info.dateStr);
                }
            });
            calendar.render();
        });
        const reservedSlots = {
            "2025-08-22": ["10:00", "14:00"],
            "2025-08-23": ["09:00", "11:00", "15:00"]
        };
        function showTimeSlots(date) {
            const timeSlotsDiv = document.getElementById("timeSlots");
            timeSlotsDiv.innerHTML = `<h6 class="mb-3">${date} ì˜ˆì•½ ê°€ëŠ¥ ì‹œê°„</h6>`;
            const allSlots = ["09:00", "10:00", "11:00", "13:00", "14:00", "15:00", "16:00"];
            const reserved = reservedSlots[date] || [];
            allSlots.forEach(slot => {
                const btn = document.createElement("button");
                const isReserved = reserved.includes(slot);
                btn.className = "btn m-1 " + (isReserved ? "btn-secondary" : "btn-success");
                btn.innerText = slot;
                btn.disabled = isReserved;
                if (!isReserved) {
                    btn.onclick = () => {
                        bookingData.date = date;
                        bookingData.time = slot;
                        document.querySelectorAll("#timeSlots button").forEach(b => b.classList.remove("btn-warning"));
                        btn.classList.add("btn-warning");
                    };
                }
                timeSlotsDiv.appendChild(btn);
            });
        }

        // ì˜ˆì•½ í™•ì •
        function confirmBooking() {
            let bookings = JSON.parse(localStorage.getItem("bookings")) || [];
            bookings.push({ ...bookingData, status: "ëŒ€ê¸°ì¤‘" });
            localStorage.setItem("bookings", JSON.stringify(bookings));

            // ë¡œê·¸ì¸ ì‚¬ìš©ì íˆìŠ¤í† ë¦¬ ê¸°ë¡
            let currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (currentUser) {
                if (!currentUser.history) currentUser.history = [];
                currentUser.history.push({
                    date: new Date().toLocaleString(),
                    detail: `${bookingData.course} - ${bookingData.date} ${bookingData.time}`
                });
                localStorage.setItem("currentUser", JSON.stringify(currentUser));
            }
            alert("ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            window.location.href = "index.html";
        }
    </script>
</body>

</html>