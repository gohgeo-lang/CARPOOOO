<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CARPOOOO - ì„¸ì°¨ ì˜ˆì•½í•˜ê¸°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
    <link href="style.css" rel="stylesheet">
    <link href="booking.css" rel="stylesheet">
    <style>
        .step {
            display: none;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }

        .step.active {
            display: block;
            opacity: 1;
        }

        #calendar {
            min-height: 500px;
            margin: 20px 0;
        }
    </style>
</head>

<body>
    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="header">
        <div>
            <h4 class="fw-bold mb-0">ì„¸ì°¨ ì˜ˆì•½í•˜ê¸°</h4>
        </div>
    </div>

    <div class="container mt-4">
        <!-- ì§„í–‰ë°” -->
        <div class="progress mb-4">
            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 20%;">Step 1 / 5</div>
        </div>

        <!-- ì˜ˆì•½ íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ -->
        <div class="modal fade" id="historyModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">ìµœê·¼ê¸°ë¡</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body" id="historyList"></div>
                </div>
            </div>
        </div>

        <!-- Step 1: ì˜ˆì•½ì ì •ë³´ -->
        <div class="step active" id="step1">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">ì˜ˆì•½ì ì •ë³´</h5>
                <button type="button" class="btn btn-link btn-sm text-muted text-decoration-none" data-bs-toggle="modal"
                    data-bs-target="#historyModal">
                    ì´ì „ê¸°ë¡ì—ì„œ ì…ë ¥í•˜ê¸°
                </button>
            </div>
            <input type="text" class="form-control mb-2" id="name" placeholder="ì˜ˆì•½ì ì„±í•¨">
            <input type="tel" class="form-control mb-2" id="phone" placeholder="ì—°ë½ì²˜">
            <input type="text" class="form-control mb-2" id="address" placeholder="ì£¼ì†Œ ê²€ìƒ‰" readonly
                onclick="execDaumPostcode()">
            <script src="https://t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
            <script>
                function execDaumPostcode() {
                    new daum.Postcode({
                        oncomplete: function (data) {
                            document.getElementById("address").value = data.address;
                        }
                    }).open();
                }
            </script>
            <input type="text" class="form-control mb-2" id="addressDetail" placeholder="ìƒì„¸ ìœ„ì¹˜ (ì˜ˆ: ì•„íŒŒíŠ¸ ë™/í˜¸)">
            <button class="btn btn-primary w-100 mt-3" onclick="nextStep(2)">ë‹¤ìŒ</button>
        </div>

        <!-- Step 2: ì°¨ëŸ‰ ì •ë³´ -->
        <div class="step" id="step2">
            <h5>ì°¨ëŸ‰ ì •ë³´</h5>
            <ul class="nav nav-tabs" id="carTab" role="tablist">
                <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#mycar"
                        type="button">ë‚´ ì°¨ëŸ‰ì—ì„œ ì„ íƒ</button></li>
                <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#newcar"
                        type="button">ìƒˆë¡œìš´ ì°¨ëŸ‰ ë“±ë¡</button></li>
            </ul>
            <div class="tab-content mt-3">
                <div class="tab-pane fade show active" id="mycar">
                    <div id="myCarList" class="list-group"></div>
                </div>
                <div class="tab-pane fade" id="newcar">
                    <input type="text" class="form-control mb-2" id="carNumber" placeholder="ì°¨ëŸ‰ ë²ˆí˜¸íŒ">
                    <select class="form-select mb-2" id="carCompany">
                        <option value="">ë¸Œëœë“œ ì„ íƒ</option>
                    </select>
                    <select class="form-select mb-2" id="carModel">
                        <option value="">ëª¨ë¸ ì„ íƒ</option>
                    </select>
                    <div class="alert alert-info" id="carSizeBox" style="display:none;"></div>
                </div>
            </div>
            <button class="btn btn-secondary mt-3" onclick="prevStep(1)">ì´ì „</button>
            <button class="btn btn-primary mt-3 float-end" onclick="nextStep(3)">ë‹¤ìŒ</button>
        </div>
        <!-- Step3 -->
        <div class="step" id="step3">
            <h5>ì„¸ì°¨ ì½”ìŠ¤ ì„ íƒ</h5>

            <!-- 1) ì„¸ì°¨ ì¢…ë¥˜ -->
            <div class="mb-3">
                <label class="fw-bold">ì„¸ì°¨ ì¢…ë¥˜</label><br>
                <input type="radio" name="washType" value="ì¼ë°˜ì„¸ì°¨" onchange="selectWashType('ì¼ë°˜ì„¸ì°¨')"> ì¼ë°˜ì„¸ì°¨
                <input type="radio" name="washType" value="ì •ê¸°ì„¸ì°¨" onchange="selectWashType('ì •ê¸°ì„¸ì°¨')"> ì •ê¸°ì„¸ì°¨
            </div>

            <!-- 2) êµ¬ë…ê°œì›”ìˆ˜ -->
            <div id="subscriptionBox" style="display:none;" class="mb-3">
                <label class="fw-bold">êµ¬ë… ê°œì›” ìˆ˜</label>
                <select id="subscriptionSelect" class="form-select" onchange="updateSubscription(this.value)">
                    <option value="1">1ê°œì›” (ê¸°ë³¸ê°€)</option>
                    <option value="3">3ê°œì›” (5% í• ì¸)</option>
                    <option value="6">6ê°œì›” (10% í• ì¸)</option>
                    <option value="12">12ê°œì›” (20% í• ì¸)</option>
                </select>
            </div>

            <!-- 3) ì½”ìŠ¤ ì„ íƒ -->
            <div class="mb-3">
                <label class="fw-bold">ì½”ìŠ¤ ì„ íƒ</label>
                <select id="courseSelect" class="form-select" onchange="selectCourse(this.value)">
                    <option value="">ì½”ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="basic">ë² ì´ì§ì½”ìŠ¤</option>
                    <option value="premium">í”„ë¦¬ë¯¸ì—„ì½”ìŠ¤</option>
                </select>
            </div>

            <!-- 4) ì˜µì…˜ -->
            <div class="mb-3">
                <label><input type="checkbox" id="interiorOption" onchange="toggleInterior()"> ì‹¤ë‚´ì„¸ì°¨ ì¶”ê°€</label>
            </div>

            <!-- 5) ì¿ í° -->
            <button class="btn btn-outline-primary w-100" onclick="openCouponBox()">ğŸŸ ì¿ í°/ìƒí’ˆê¶Œ ë³´ê´€í•¨</button>

            <!-- ì½”ìŠ¤ ì„¤ëª… -->
            <div id="courseDescription" class="mt-3 text-muted small"></div>

            <!-- ë²„íŠ¼ ì¶”ê°€ -->
            <button class="btn btn-secondary mt-3" onclick="prevStep(2)">ì´ì „</button>
            <button class="btn btn-primary mt-3 float-end" onclick="nextStep(4)">ë‹¤ìŒ</button>

        </div>



        <!-- Step 4: ë‚ ì§œ & ì‹œê°„ -->
        <div class="step" id="step4">
            <h5>ğŸ“… ì˜ˆì•½ ë‚ ì§œ & ì‹œê°„</h5>
            <div id="calendar"></div>
            <div id="timeSlots" class="mt-3"></div>
            <button class="btn btn-secondary mt-3" onclick="prevStep(3)">ì´ì „</button>
            <button class="btn btn-primary mt-3 float-end" onclick="nextStep(5)">ë‹¤ìŒ</button>
        </div>

        <!-- Step 5: í™•ì¸ -->
        <div class="step" id="step5">
            <h5>âœ… ì˜ˆì•½ í™•ì¸</h5>
            <div id="summary" class="border p-3 mb-3 bg-light"></div>
            <button class="btn btn-secondary" onclick="prevStep(4)">ì´ì „</button>
            <button class="btn btn-success float-end" onclick="confirmBooking()">ê²°ì œí•˜ê¸°</button>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="carData.js"></script>
    <script src="courseInfo.js"></script>



    <script>
        let bookingData = {};
        let currentStep = 1;
        let calendar;
        let appliedDiscount = 0;

        // Step ì§„í–‰ë°”
        function updateProgress(step) {
            currentStep = step;
            const percent = (step / 5) * 100;
            document.getElementById("progressBar").style.width = percent + "%";
            document.getElementById("progressBar").innerText = `Step ${step} / 5`;
        }

        // Step ì´ë™
        function nextStep(step) {
            // Step2ë¡œ ì´ë™: ì˜ˆì•½ì ì •ë³´ í•„ìˆ˜
            if (step === 2) {
                const name = document.getElementById("name").value.trim();
                const phone = document.getElementById("phone").value.trim();
                const address = document.getElementById("address").value.trim();
                if (!name) return alert("ì˜ˆì•½ì ì„±í•¨ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                if (!phone) return alert("ì—°ë½ì²˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                if (!address) return alert("ì£¼ì†Œë¥¼ ê²€ìƒ‰í•´ì£¼ì„¸ìš”.");
                // í†µê³¼ ì‹œ bookingDataì— ë°˜ì˜
                bookingData.name = name;
                bookingData.phone = phone;
                bookingData.address = address + " " + (document.getElementById("addressDetail").value || "");
            }

            // Step3ë¡œ ì´ë™: ì°¨ëŸ‰ ì„ íƒ í•„ìˆ˜
            if (step === 3) {
                if (!bookingData.carCompany || !bookingData.carModel || !bookingData.carSize) {
                    return alert("ì°¨ëŸ‰ ì •ë³´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                }
            }

            // Step4ë¡œ ì´ë™: ì„¸ì°¨ ì½”ìŠ¤ ì„ íƒ í•„ìˆ˜(ì—¬ê¸°ê°€ ë¹ ì ¸ ìˆì—ˆìŒ!)
            if (step === 4) {
                if (!bookingData.washType) return alert("ì„¸ì°¨ ì¢…ë¥˜ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                if (!bookingData.course || !bookingData.courseKey) return alert("ì½”ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                if (bookingData.washType === "ì •ê¸°ì„¸ì°¨" && !bookingData.months) {
                    return alert("êµ¬ë… ê°œì›”ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
                }
            }

            // Step5ë¡œ ì´ë™: ë‚ ì§œ/ì‹œê°„ í•„ìˆ˜
            if (step === 5) {
                if (!bookingData.date) return alert("ì˜ˆì•½ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                if (!bookingData.time) return alert("ì˜ˆì•½ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
            }

            // --- ì‹¤ì œ í™”ë©´ ì „í™˜ ---
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            updateProgress(step);

            // ë¶€ê°€ ì²˜ë¦¬
            if (step === 3) {
                // ê°€ê²©/ì¹´ë“œ ê°±ì‹  (í•„ìš” ì‹œ)
                if (typeof updateSummaryBar === "function") updateSummaryBar();
            }
            if (step === 4) {
                if (!calendar) initCalendar();
                // ë Œë” íƒ€ì´ë° ìœ ì˜ˆ
                setTimeout(() => calendar && calendar.render(), 200);
            }
            if (step === 5) {
                if (typeof showSummary === "function") showSummary();
            }
        }

        function prevStep(step) {
            document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
            document.getElementById('step' + step).classList.add('active');
            updateProgress(step);
        }

        // ì‚¬ìš©ì ê¸°ë³¸ì •ë³´ ìë™ ì…ë ¥
        document.addEventListener("DOMContentLoaded", () => {
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (currentUser) {
                document.getElementById("name").value = currentUser.name || "";
                document.getElementById("phone").value = currentUser.phone || "";
                document.getElementById("address").value = currentUser.address || "";
                document.getElementById("addressDetail").value = currentUser.addressDetail || "";
                bookingData.name = currentUser.name || "";
                bookingData.phone = currentUser.phone || "";
                bookingData.address = (currentUser.address || "") + " " + (currentUser.addressDetail || "");
            }
            loadMyCars();
            initCarDropdown();
        });

        // ì°¨ëŸ‰ ë¦¬ìŠ¤íŠ¸
        function loadMyCars() {
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            const myCarList = document.getElementById("myCarList");
            myCarList.innerHTML = "";
            if (currentUser && currentUser.cars?.length > 0) {
                currentUser.cars.forEach((car, idx) => {
                    const btn = document.createElement("button");
                    btn.className = "list-group-item list-group-item-action";
                    btn.innerText = `${car.carNumber} - ${car.carCompany} ${car.carModel} (${car.carSize})`;
                    btn.onclick = () => {
                        bookingData.carNumber = car.carNumber;
                        bookingData.carCompany = car.carCompany;
                        bookingData.carModel = car.carModel;
                        bookingData.carSize = car.carSize;
                        document.querySelectorAll("#myCarList button").forEach(b => b.classList.remove("active"));
                        btn.classList.add("active");
                    };
                    myCarList.appendChild(btn);
                    if (idx === 0) btn.click();
                });
            } else {
                myCarList.innerHTML = `<p class="text-muted">ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
            }
        }

        // ë¸Œëœë“œ/ëª¨ë¸ ë“œë¡­ë‹¤ìš´
        function initCarDropdown() {
            const brandSelect = document.getElementById("carCompany");
            const modelSelect = document.getElementById("carModel");
            for (let brand in carData) {
                let opt = document.createElement("option");
                opt.value = brand; opt.textContent = brand;
                brandSelect.appendChild(opt);
            }
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (currentUser && currentUser.cars?.length > 0) {
                const car = currentUser.cars[0];
                brandSelect.value = car.carCompany;
                Object.keys(carData[car.carCompany]).forEach(size => {
                    carData[car.carCompany][size].forEach(model => {
                        let opt = document.createElement("option");
                        opt.value = model; opt.textContent = model;
                        modelSelect.appendChild(opt);
                    });
                });
                modelSelect.value = car.carModel;
                bookingData.carNumber = car.carNumber;
                bookingData.carCompany = car.carCompany;
                bookingData.carModel = car.carModel;
                bookingData.carSize = car.carSize;
            }
            brandSelect.addEventListener("change", () => {
                modelSelect.innerHTML = "<option value=''>ëª¨ë¸ ì„ íƒ</option>";
                if (brandSelect.value) {
                    Object.keys(carData[brandSelect.value]).forEach(size => {
                        carData[brandSelect.value][size].forEach(model => {
                            let opt = document.createElement("option");
                            opt.value = model; opt.textContent = model;
                            modelSelect.appendChild(opt);
                        });
                    });
                }
            });
            modelSelect.addEventListener("change", () => {
                const brand = brandSelect.value;
                const model = modelSelect.value;
                let detectedSize = "";
                Object.keys(carData[brand]).forEach(size => {
                    if (carData[brand][size].includes(model)) detectedSize = size;
                });
                bookingData.carCompany = brand;
                bookingData.carModel = model;
                bookingData.carSize = detectedSize;
                bookingData.carNumber = document.getElementById("carNumber").value;
                const box = document.getElementById("carSizeBox");
                box.style.display = "block";
                box.innerText = `ìë™ ë¶„ë¥˜ëœ ì°¨ëŸ‰ í¬ê¸°: ${bookingData.carSize}`;
            });
        }

        // ê°€ê²©í‘œ + ì„ íƒ ë³µì›
        const priceTable = {
            "ê²½í˜•": { one: 25000, month4: 35000, month8: 55000, interior: 10000 },
            "ì¤€ì¤‘í˜•": { one: 30000, month4: 40000, month8: 65000, interior: 10000 },
            "ì¤€ëŒ€í˜•": { one: 35000, month4: 45000, month8: 75000, interior: 10000 },
            "ëŒ€í˜•": { one: 40000, month4: 50000, month8: 80000, interior: 10000 },
            "SUV": { one: 40000, month4: 50000, month8: 85000, interior: 10000 },
            "RV": { one: 45000, month4: 55000, month8: 90000, interior: 10000 }
        };


        function selectWashType(type) {
            bookingData.washType = type;
            if (type === "ì •ê¸°ì„¸ì°¨") {
                document.getElementById("subscriptionBox").style.display = "block";
                bookingData.months = 1; // ê¸°ë³¸ 1ê°œì›”
            } else {
                document.getElementById("subscriptionBox").style.display = "none";
                bookingData.months = null;
            }
            updateSummaryBar();
        }

        function updateSubscription(months) {
            bookingData.months = parseInt(months);
            updateSummaryBar();
        }

        function selectCourse(value) {
            bookingData.courseKey = value || null;

            if (value === "basic") {
                bookingData.course = courseInfo.basic.title;
                bookingData.courseDesc = courseInfo.basic.tagline;
            } else if (value === "premium") {
                bookingData.course = courseInfo.premium.title;
                bookingData.courseDesc = courseInfo.premium.tagline;
            } else {
                bookingData.course = "";
                bookingData.courseDesc = "";
            }
            updateSummaryBar(); // ì„ íƒ ì¦‰ì‹œ ì¹´ë“œ ê°±ì‹  & ê¸ˆì•¡ ê°±ì‹ 
        }


        function toggleInterior() {
            bookingData.interior = document.getElementById("interiorOption").checked;
            updateSummaryBar();
        }

        function openCouponBox() {
            const myCoupons = [
                { code: "WELCOME10", discount: 0.1, text: "ì²« êµ¬ë§¤ 10%" },
                { code: "EVENT20", discount: 0.2, text: "ì´ë²¤íŠ¸ 20%" }
            ];
            const best = myCoupons.reduce((a, b) => a.discount > b.discount ? a : b);
            bookingData.discountText = best.text;
            appliedDiscount = best.discount;
            alert(`${best.text} ì¿ í°ì´ ìë™ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!`);
            updateSummaryBar();
        }
        //ì˜ˆì•½ëœ ì½”ìŠ¤ ì„¤ëª…
        function updateSummaryBar() {
            // ê¸ˆì•¡ ê³„ì‚°
            let total = 0;
            if (bookingData.carSize) {
                let base = priceTable[bookingData.carSize]?.one || 30000;
                total = base;

                if (bookingData.washType === "ì •ê¸°ì„¸ì°¨" && bookingData.months) {
                    if (bookingData.months == 3) total = base * 3 * 0.95;
                    if (bookingData.months == 6) total = base * 6 * 0.9;
                    if (bookingData.months == 12) total = base * 12 * 0.8;
                    if (bookingData.months == 1) total = base;
                }

                // âœ… carSizeê°€ priceTableì— ì—†ì„ ë•Œ ë°©ì–´
                if (bookingData.interior && priceTable[bookingData.carSize]) {
                    total += priceTable[bookingData.carSize].interior;
                }

                if (appliedDiscount > 0) total *= (1 - appliedDiscount);
            }

            bookingData.finalPrice = total;

            // ì½”ìŠ¤ ìƒì„¸ ì¹´ë“œ ê°±ì‹ 
            renderCourseCard();
        }


        function renderCourseCard() {
            const key = bookingData.courseKey;
            const info = key ? courseInfo[key] : null;

            // ì„ íƒ ì•ˆ í–ˆìœ¼ë©´ ì¹´ë“œ ìˆ¨ê¹€
            if (!bookingData.washType && !bookingData.course && !bookingData.interior) {
                document.getElementById("courseDescription").innerHTML = "";
                return;
            }

            const size = bookingData.carSize;
            const time = info && size ? (info.timeBySize[size] || "") : "";
            const monthsText = bookingData.washType === "ì •ê¸°ì„¸ì°¨" && bookingData.months
                ? bookingData.months + "ê°œì›”"
                : "";
            const optionText = bookingData.interior ? "ì‹¤ë‚´ì„¸ì°¨ í¬í•¨" : "";
            const discountText = bookingData.discountText || "";

            const includesHtml = info && info.includes.length
                ? info.includes.map(i => `<li>${i}</li>`).join("")
                : "";
            const notHtml = info && info.not_included.length
                ? info.not_included.map(i => `<li>${i}</li>`).join("")
                : "";
            const recommend = info ? info.recommend : "";

            // ì¹´ë“œ UI
            let html = `
      <div class="card shadow-sm border-0">
        <div class="card-body p-3">
          ${bookingData.course ? `<h6 class="card-title mb-1">${bookingData.course}</h6>` : ""}
          ${bookingData.courseDesc ? `<p class="card-subtitle text-muted small mb-2">${bookingData.courseDesc}</p>` : ""}
          ${recommend ? `<div class="small mb-2"><i class="bi bi-stars"></i> ${recommend}</div>` : ""}

          <div class="row g-2 small">
    `;

            if (includesHtml) {
                html += `
        <div class="col-12 col-md-6">
          <div class="border rounded p-2 h-100">
            <div class="fw-semibold mb-1">í¬í•¨ í•­ëª©</div>
            <ul class="mb-0 ps-3">${includesHtml}</ul>
          </div>
        </div>`;
            }

            if (notHtml) {
                html += `
        <div class="col-12 col-md-6">
          <div class="border rounded p-2 h-100">
            <div class="fw-semibold mb-1">ë¯¸í¬í•¨</div>
            <ul class="mb-0 ps-3">${notHtml}</ul>
          </div>
        </div>`;
            }

            html += `</div><hr class="my-2"><div class="d-flex flex-wrap gap-3 small">`;

            if (size) html += `<div><b>ì°¨ëŸ‰ í¬ê¸°:</b> ${size}</div>`;
            if (time) html += `<div><b>ì˜ˆìƒ ì†Œìš”:</b> ${time}</div>`;
            if (bookingData.washType) html += `<div><b>ì„¸ì°¨ì¢…ë¥˜:</b> ${bookingData.washType}</div>`;
            if (monthsText) html += `<div><b>êµ¬ë…ê°œì›”:</b> ${monthsText}</div>`;
            if (optionText) html += `<div><b>ì˜µì…˜:</b> ${optionText}</div>`;
            if (discountText) html += `<div><b>í• ì¸:</b> ${discountText}</div>`;

            html += `
          </div>
          ${bookingData.finalPrice ? `<div class="mt-2 fw-bold text-primary">ìµœì¢… ê¸ˆì•¡: ${bookingData.finalPrice.toLocaleString()}ì›</div>` : ""}
          <div class="text-muted small mt-1">â€» ì˜¤ì—¼ë„/ê¸°ìƒ/ì°¨ëŸ‰ ìƒíƒœì— ë”°ë¼ ì‘ì—… ì‹œê°„ê³¼ ê¸ˆì•¡ì´ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
        </div>
      </div>
    `;

            document.getElementById("courseDescription").innerHTML = html;
        }

        // === ì—¬ê¸°ì¯¤ì— ë„£ì–´ì£¼ì‹œë©´ ë¼ìš” ===

        // bookingData â†’ Step3 UI ë°˜ì˜ í•¨ìˆ˜
        function applyBookingDataToUI() {
            // ì„¸ì°¨ ì¢…ë¥˜ (radio)
            if (bookingData.washType) {
                document.querySelectorAll("input[name='washType']").forEach(radio => {
                    radio.checked = (radio.value === bookingData.washType);
                });
                selectWashType(bookingData.washType); // êµ¬ë…ë°•ìŠ¤ ë³´ì´ê¸°/ìˆ¨ê¸°ê¸° ì²˜ë¦¬
            }

            // êµ¬ë… ê°œì›” (select)
            if (bookingData.months) {
                document.getElementById("subscriptionSelect").value = bookingData.months;
            }

            // ì½”ìŠ¤ (select)
            if (bookingData.courseKey) {
                document.getElementById("courseSelect").value = bookingData.courseKey;
                selectCourse(bookingData.courseKey); // ì½”ìŠ¤ ì¹´ë“œ ì—…ë°ì´íŠ¸
            }

            // ì‹¤ë‚´ ì˜µì…˜ (checkbox)
            document.getElementById("interiorOption").checked = !!bookingData.interior;

            // ìµœì¢… ì¹´ë“œ ê°±ì‹ 
            updateSummaryBar();
        }


        //ìº˜ë¦°ë” ì´ˆê¸°í™”
        function initCalendar() {
            const calendarEl = document.getElementById("calendar");
            if (!calendar) {
                calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: "dayGridMonth",
                    selectable: true,
                    dateClick: function (info) {
                        bookingData.date = info.dateStr;
                        renderTimeSlots(info.dateStr);
                    }

                });
                calendar.render();
            }
        }

        //ìº˜ë¦°ë” ì‹œê°„ ë²„íŠ¼
        function renderTimeSlots(dateStr) {
            const slots = ["09:00", "11:00", "13:00", "15:00", "17:00"];
            const container = document.getElementById("timeSlots");
            container.innerHTML = "";
            slots.forEach(t => {
                const btn = document.createElement("button");
                btn.className = "btn btn-outline-primary m-1";
                btn.innerText = t;
                btn.onclick = () => {
                    bookingData.time = t;
                    document.querySelectorAll("#timeSlots button").forEach(b => b.classList.remove("active"));
                    btn.classList.add("active");
                };
                container.appendChild(btn);
            });
        }

        //ì˜ˆì•½í™•ì¸
        function showSummary() {
            const summaryDiv = document.getElementById("summary");
            summaryDiv.innerHTML = `
        <p><b>ì˜ˆì•½ì:</b> ${bookingData.name}</p>
        <p><b>ì—°ë½ì²˜:</b> ${bookingData.phone}</p>
        <p><b>ì£¼ì†Œ:</b> ${bookingData.address}</p>
        <p><b>ì°¨ëŸ‰:</b> ${bookingData.carNumber} - ${bookingData.carCompany} ${bookingData.carModel} (${bookingData.carSize})</p>
        <p><b>ì„¸ì°¨ì¢…ë¥˜:</b> ${bookingData.washType}</p>
        <p><b>ì½”ìŠ¤:</b> ${bookingData.course}</p>
        <p><b>ì˜µì…˜:</b> ${bookingData.interior ? "ì‹¤ë‚´ì„¸ì°¨" : "ì—†ìŒ"}</p>
        <p><b>ë‚ ì§œ/ì‹œê°„:</b> ${bookingData.date} ${bookingData.time}</p>
        <p><b>ìµœì¢…ê¸ˆì•¡:</b> <span class="fw-bold text-primary">${bookingData.finalPrice.toLocaleString()}ì›</span></p>
    `;
        }



        // ì˜ˆì•½ í™•ì •
        function confirmBooking() {
            let bookings = JSON.parse(localStorage.getItem("bookings")) || [];
            const newBooking = { ...bookingData, status: "ëŒ€ê¸°ì¤‘" };
            bookings.push(newBooking);
            localStorage.setItem("bookings", JSON.stringify(bookings));

            let currentUser = JSON.parse(localStorage.getItem("currentUser"));
            if (!currentUser) {
                currentUser = {
                    name: bookingData.name,
                    phone: bookingData.phone,
                    address: bookingData.address,
                    addressDetail: document.getElementById("addressDetail").value,
                    cars: [],
                    history: []
                };
            }
            if (!currentUser.history) currentUser.history = [];

            // âœ… í•„ìš”í•œ ê°’ ëª¨ë‘ ì €ì¥
            currentUser.history.push({
                date: new Date().toLocaleString(),
                washType: bookingData.washType,
                months: bookingData.months,
                courseKey: bookingData.courseKey,
                course: bookingData.course,
                carNumber: bookingData.carNumber,
                carCompany: bookingData.carCompany,
                carModel: bookingData.carModel,
                carSize: bookingData.carSize,
                dateStr: bookingData.date,
                time: bookingData.time,
                finalPrice: bookingData.finalPrice,
                detail: `${bookingData.course} - ${bookingData.date} ${bookingData.time}`
            });

            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            alert("ì˜ˆì•½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
            window.location.href = "index.html";
        }


        // íˆìŠ¤í† ë¦¬ ëª¨ë‹¬ ì±„ìš°ê¸°
        document.getElementById("historyModal").addEventListener("show.bs.modal", () => {
            const currentUser = JSON.parse(localStorage.getItem("currentUser"));
            const listDiv = document.getElementById("historyList");
            listDiv.innerHTML = "";
            if (!currentUser || !currentUser.history || currentUser.history.length === 0) {
                listDiv.innerHTML = "<p class='text-muted'>ì˜ˆì•½ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            currentUser.history.forEach((h) => {
                const card = document.createElement("div");
                card.className = "card mb-3 shadow-sm";
                card.style.cursor = "pointer";
                card.innerHTML = `
            <div class="card-body p-3">
                <div class="d-flex justify-content-between">
                    <h6 class="card-title mb-1">${h.course || "ì½”ìŠ¤ ë¯¸ì§€ì •"}</h6>
                    <small class="text-muted">${h.date}</small>
                </div>
                <p class="card-subtitle text-muted small mb-2">
                    ${h.carNumber} - ${h.carCompany} ${h.carModel} (${h.carSize})
                </p>
                <p class="mb-1"><b>ë‚ ì§œ/ì‹œê°„:</b> ${h.dateStr} ${h.time}</p>
                <p class="mb-0"><b>ê²°ì œê¸ˆì•¡:</b> ${h.finalPrice?.toLocaleString() || 0}ì›</p>
            </div>
        `;
                card.onclick = () => {
                    document.getElementById("name").value = currentUser.name || "";
                    document.getElementById("phone").value = currentUser.phone || "";
                    document.getElementById("address").value = currentUser.address || "";
                    document.getElementById("addressDetail").value = currentUser.addressDetail || "";

                    bookingData = {
                        ...bookingData, ...h,
                        name: currentUser.name,
                        phone: currentUser.phone,
                        address: currentUser.address
                    };

                    // âœ… UIì™€ ë™ê¸°í™”
                    applyBookingDataToUI();

                    const now = new Date();
                    const selectedDate = new Date(`${h.dateStr} ${h.time}`);
                    if (!(selectedDate > now)) {
                        bookingData.date = "";
                        bookingData.time = "";
                        alert("ê³¼ê±° ì˜ˆì•½ì´ë¯€ë¡œ ë‚ ì§œ/ì‹œê°„ì€ ë‹¤ì‹œ ì„ íƒí•´ì£¼ì„¸ìš”.");
                    }
                    bootstrap.Modal.getInstance(document.getElementById("historyModal")).hide();
                    nextStep(4);
                    return;
                };

                listDiv.appendChild(card);
            });
        });

    </script>
</body>

</html>