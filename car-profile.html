<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>CARPOOOO - ë‚´ ì°¨ëŸ‰ í”„ë¡œí•„</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link href="style.css" rel="stylesheet" />
    <style>
      /* í—¤ë” */
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #29335a;
        /* ë¸Œëœë“œ íŒŒë€ìƒ‰ */
        color: white;
      }

      .header-center {
        text-align: center;
      }

      .btn-save-top {
        border: none;
        color: #ffffff;
        background: none;
        font-weight: 600;
        padding: 6px 16px;
        border-radius: 6px;
        cursor: pointer;
      }

      .btn-save-top:hover {
        color: #f1f1f1;
      }

      .car-card {
        position: relative;
        border-radius: 16px;
        min-height: 250px;
        background: #29335a;
        background-size: cover;
        background-position: center;
        overflow: hidden;
        color: white;
        margin-bottom: 20px;
      }

      /* ì¹´ë“œ hover ì‹œ í”ë“¤ë¦¼ íš¨ê³¼ */
      .car-card:hover {
        animation: shake 0.3s;
      }

      /* í”ë“¤ë¦¼ í‚¤í”„ë ˆì„ */
      @keyframes shake {
        0% {
          transform: translateY(0);
        }

        25% {
          transform: translateY(-3px);
        }

        50% {
          transform: translateY(3px);
        }

        75% {
          transform: translateY(-2px);
        }

        100% {
          transform: translateY(0);
        }
      }

      /* ì¹´ë“œ ì „ì²´ ì˜¤ë²„ë ˆì´ */
      .car-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.45);
        /* ì „ì²´ ì–´ë‘¡ê²Œ */
        border-radius: 16px;
        z-index: 0;
      }

      /* ë‹‰ë„¤ì„ ìƒë‹¨ ê³ ì • */
      .car-nickname {
        position: absolute;
        top: 15px;
        left: 20px;
        margin: 0;
        font-size: 1.2rem;
        font-weight: bold;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        z-index: 2;
      }

      /* í•˜ë‹¨ ê³ ì • ì •ë³´ */
      .car-info-wrapper {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        padding: 15px;
        z-index: 2;
      }

      .car-info-wrapper p {
        margin: 0 0 8px;
        font-size: 0.9rem;
        color: #ddd;
      }

      /* ì°¨ëŸ‰ ì„¸ë¶€ì •ë³´ ë°•ìŠ¤ */
      .car-stats {
        display: flex;
        justify-content: space-around;
        gap: 10px;
      }

      .car-stats div {
        flex: 1;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 6px;
        padding: 6px;
        text-align: center;
      }

      .car-stats p {
        margin: 0;
        font-size: 0.8rem;
        color: #ccc;
      }

      .car-stats h4 {
        margin: 4px 0 0;
        font-weight: bold;
        color: #fff;
      }

      /* ë¸Œëœë“œ ë¡œê³ ëŠ” í•­ìƒ ìš°ìƒë‹¨ */
      .car-card .brand-logo {
        position: absolute;
        top: 20px;
        right: 20px;
        height: 50px;
        z-index: 2;
      }

      .add-car-btn {
        display: block;
        width: 100%;
        text-align: center;
        margin-top: 15px;
        padding: 12px;
        border: 2px dashed #7b8fa2;
        border-radius: 12px;
        color: #7b8fa2;
        font-weight: bold;
        cursor: pointer;
        background: white;
      }

      .add-car-btn:hover {
        background: #f5f5f5;
      }

      /* ì‚­ì œ ëª¨ë“œ ì¹´ë“œ íš¨ê³¼ */
      .car-card.delete-mode {
        cursor: pointer;
        position: relative;
        transition: filter 0.2s ease;
      }

      /* ì„ íƒëœ ì¹´ë“œ */
      .car-card.selected {
        filter: brightness(50%);
        animation: none !important;
        transform: scale(0.99);
      }

      @keyframes shake-vertical {
        0% {
          transform: translateY(0px);
        }
        20% {
          transform: translateY(-2px);
        }
        40% {
          transform: translateY(2px);
        }
        60% {
          transform: translateY(-1px);
        }
        80% {
          transform: translateY(1px);
        }
        100% {
          transform: translateY(0px);
        }
      }

      .car-card.delete-mode {
        animation: shake-vertical 0.281s infinite ease-in-out; /* ğŸ”¹ 0.216s â†’ 0.281s */
      }

      /* ëœë¤ íš¨ê³¼ (ë¹„ìœ¨ ë§ì¶° ì¡°ì •) */
      .car-card.delete-mode:nth-child(2n) {
        animation-duration: 0.312s; /* 0.24s â†’ 0.312s */
        animation-delay: 0.05s;
      }
      .car-card.delete-mode:nth-child(3n) {
        animation-duration: 0.249s; /* 0.192s â†’ 0.249s */
        animation-delay: -0.03s;
      }
      .car-card.delete-mode:nth-child(4n) {
        animation-duration: 0.343s; /* 0.264s â†’ 0.343s */
        animation-delay: 0.1s;
      }
    </style>
  </head>

  <body>
    <!-- ìƒë‹¨ í—¤ë” -->
    <div class="header">
      <!-- ë’¤ë¡œê°€ê¸° ë²„íŠ¼ -->
      <button
        class="btn btn-link text-white me-2"
        onclick="goBackOrHome()"
        style="font-size: 1.2rem"
      >
        <i class="bi bi-chevron-left"></i>
      </button>

      <div>
        <h4 class="fw-bold mb-0">ì°¨ê³ </h4>
      </div>
      <button type="button" class="btn-save-top" onclick="toggleDeleteMode()">
        <i class="bi bi-trash3"></i>
      </button>
    </div>

    <div class="container mt-4" style="max-width: 700px">
      <div id="carCards"></div>

      <!-- ì°¨ëŸ‰ ì¶”ê°€ ë²„íŠ¼ -->
      <div
        class="add-car-btn"
        onclick="location.href='car-register.html?from=profile'"
      >
        + ë‹¤ë¥¸ ì°¨ëŸ‰ ì¶”ê°€í•˜ê¸°
      </div>
    </div>

    <script>
      //ë’¤ë¡œê°€ê¸°
      function goBack() {
        const ref = document.referrer;

        // ì´ì „ í˜ì´ì§€ê°€ car-detailì´ë©´ í™ˆìœ¼ë¡œ
        if (ref.includes("car-detail.html")) {
          window.location.href = "index.html";
        } else if (ref) {
          history.back();
        } else {
          window.location.href = "index.html";
        }
      }

      const currentUser = JSON.parse(localStorage.getItem("currentUser"));
      if (!currentUser || !currentUser.cars || currentUser.cars.length === 0) {
        alert("ë“±ë¡ëœ ì°¨ëŸ‰ì´ ì—†ìŠµë‹ˆë‹¤.");
        window.location.href = "car-register.html";
      } else {
        const carCardsDiv = document.getElementById("carCards");
        carCardsDiv.innerHTML = "";

        currentUser.cars.forEach((car, idx) => {
          const div = document.createElement("div");
          div.className = "car-card";

          // ë°°ê²½ì´ë¯¸ì§€ ì§€ì • (ì—†ìœ¼ë©´ ê¸°ë³¸ìƒ‰ ìœ ì§€)
          if (car.carImage) {
            div.style.backgroundImage = `url(${car.carImage})`;
          } else {
            div.style.backgroundImage = "none";
          }

          div.innerHTML = `
  <!-- ë‹‰ë„¤ì„ + ìƒì„¸ ì•„ì´ì½˜ (ìƒë‹¨ ì™¼ìª½) -->
  <h3 class="car-nickname" onclick="goDetail(${idx})">
    <span>${car.carNickname || car.carModel}</span>
    <i class="bi bi-chevron-right ms-1" style="font-size:1rem; opacity:0.7;"></i>
  </h3>

  <!-- í•˜ë‹¨ ê³ ì • ì •ë³´ -->
  <div class="car-info-wrapper">
    <p>${
      car.registerDate
        ? Math.floor(
            (Date.now() - new Date(car.registerDate)) / (1000 * 60 * 60 * 24)
          ) + "ì¼ì§¸ ê´€ë¦¬ ì¤‘"
        : ""
    } | ë§ˆì§€ë§‰ ì„¸ì°¨: ${car.lastWashDate || "-"}</p>
    <div class="car-stats">
      <div><p>ë¸Œëœë“œ</p><h4>${car.carCompany}</h4></div>
      <div><p>ë…„ì‹</p><h4>${car.carYear || "-"}</h4></div>
      <div><p>ì°¨ëŸ‰ë²ˆí˜¸</p><h4>${car.carNumber}</h4></div>
    </div>
  </div>

  <!-- ë¸Œëœë“œ ë¡œê³  -->
  <img class="brand-logo" src="${
    car.brandLogo || "https://placehold.co/50x50?text=LOGO"
  }" alt="ë¸Œëœë“œ ë¡œê³ ">
`;

          carCardsDiv.appendChild(div);
        });
      }

      function goDetail(idx) {
        localStorage.setItem("selectedCarIndex", idx);
        location.href = "car-detail.html";
      }

      let deleteMode = false;
      let selectedCars = new Set();

      function toggleDeleteMode() {
        deleteMode = !deleteMode;
        selectedCars.clear();

        const carCards = document.querySelectorAll(".car-card");
        carCards.forEach((card, idx) => {
          if (deleteMode) {
            card.classList.add("delete-mode");
            card.onclick = () => toggleSelectCard(card, idx);
          } else {
            card.classList.remove("delete-mode", "selected");
            card.onclick = () => goDetail(idx); // ì›ë˜ ìƒì„¸ë³´ê¸° ë³µêµ¬
          }
        });

        updateBottomButton();
      }

      function toggleSelectCard(card, idx) {
        if (selectedCars.has(idx)) {
          selectedCars.delete(idx);
          card.classList.remove("selected");
        } else {
          selectedCars.add(idx);
          card.classList.add("selected");
        }
        updateBottomButton();
      }

      function updateBottomButton() {
        const addCarBtn = document.querySelector(".add-car-btn");
        if (deleteMode) {
          addCarBtn.textContent = `ì„ íƒëœ ${selectedCars.size}ëŒ€ ì‚­ì œí•˜ê¸°`;
          addCarBtn.onclick = confirmDeleteSelected;
          addCarBtn.style.border = "2px solid #dc3545";
          addCarBtn.style.color = "#dc3545";
        } else {
          addCarBtn.textContent = "+ ë‹¤ë¥¸ ì°¨ëŸ‰ ì¶”ê°€í•˜ê¸°";
          addCarBtn.onclick = () => (location.href = "car-register.html");
          addCarBtn.style.border = "2px dashed #7b8fa2";
          addCarBtn.style.color = "#7b8fa2";
        }
      }

      function confirmDeleteSelected() {
        if (selectedCars.size === 0) {
          alert("ì‚­ì œí•  ì°¨ëŸ‰ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
          return;
        }
        if (confirm(`ì„ íƒëœ ${selectedCars.size}ëŒ€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
          let currentUser = JSON.parse(localStorage.getItem("currentUser"));
          // ì„ íƒëœ index ì—­ìˆœìœ¼ë¡œ ì •ë ¬í•´ì„œ splice
          [...selectedCars]
            .sort((a, b) => b - a)
            .forEach((idx) => {
              currentUser.cars.splice(idx, 1);
            });
          localStorage.setItem("currentUser", JSON.stringify(currentUser));
          location.reload();
        }
      }

      function goBackOrHome() {
        // í˜„ì¬ í˜ì´ì§€ê°€ car-profileì¼ ë•ŒëŠ” í™ˆìœ¼ë¡œ
        if (window.location.pathname.includes("car-profile.html")) {
          window.location.href = "index.html";
          return;
        }

        // ê·¸ ì™¸ì—ëŠ” ì›ë˜ ë¡œì§
        if (document.referrer && document.referrer !== window.location.href) {
          history.back();
        } else {
          window.location.href = "index.html";
        }
      }
    </script>
  </body>
</html>
